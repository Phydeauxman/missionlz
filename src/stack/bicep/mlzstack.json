{
  "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.4.1008.15138",
      "templateHash": "4556449716454835521"
    }
  },
  "parameters": {
    "resourcePrefix": {
      "type": "string",
      "defaultValue": "[format('mlz-{0}', parameters('uniqueId'))]",
      "metadata": {
        "description": "A name (3-24 alphanumeric characters in length without whitespace) used to prefix resources and generate uniqueness for resources with globally unique naming requirements like Storage Accounts and Log Analytics Workspaces"
      },
      "maxLength": 24,
      "minLength": 3
    },
    "hubSubscriptionId": {
      "type": "string",
      "defaultValue": "[subscription().subscriptionId]"
    },
    "identitySubscriptionId": {
      "type": "string",
      "defaultValue": "[parameters('hubSubscriptionId')]"
    },
    "operationsSubscriptionId": {
      "type": "string",
      "defaultValue": "[parameters('hubSubscriptionId')]"
    },
    "sharedServicesSubscriptionId": {
      "type": "string",
      "defaultValue": "[parameters('hubSubscriptionId')]"
    },
    "hubResourceGroupName": {
      "type": "string",
      "defaultValue": "[format('{0}-hub', parameters('resourcePrefix'))]"
    },
    "hubLocation": {
      "type": "string",
      "defaultValue": "[deployment().location]"
    },
    "hubVirtualNetworkName": {
      "type": "string",
      "defaultValue": "hub-vnet"
    },
    "hubSubnetName": {
      "type": "string",
      "defaultValue": "hub-subnet"
    },
    "hubVirtualNetworkAddressPrefix": {
      "type": "string",
      "defaultValue": "10.0.100.0/24"
    },
    "hubSubnetAddressPrefix": {
      "type": "string",
      "defaultValue": "10.0.100.128/27"
    },
    "hubNetworkSecurityGroupName": {
      "type": "string",
      "defaultValue": "hub-nsg"
    },
    "hubNetworkSecurityGroupRules": {
      "type": "array",
      "defaultValue": [
        {
          "name": "allow_ssh",
          "properties": {
            "description": "Allow SSH access from anywhere",
            "access": "Allow",
            "priority": 100,
            "protocol": "Tcp",
            "direction": "Inbound",
            "sourcePortRange": "*",
            "sourceAddressPrefix": "*",
            "destinationPortRange": "22",
            "destinationAddressPrefix": "*"
          }
        },
        {
          "name": "allow_rdp",
          "properties": {
            "description": "Allow RDP access from anywhere",
            "access": "Allow",
            "priority": 200,
            "protocol": "Tcp",
            "direction": "Inbound",
            "sourcePortRange": "*",
            "sourceAddressPrefix": "*",
            "destinationPortRange": "3389",
            "destinationAddressPrefix": "*"
          }
        }
      ]
    },
    "hubLogStorageAccountName": {
      "type": "string",
      "defaultValue": "[toLower(take(format('hublogs{0}', parameters('uniqueId')), 24))]"
    },
    "hubLogStorageSkuName": {
      "type": "string",
      "defaultValue": "Standard_LRS"
    },
    "firewallManagementSubnetAddressPrefix": {
      "type": "string",
      "defaultValue": "10.0.100.64/26"
    },
    "firewallClientSubnetAddressPrefix": {
      "type": "string",
      "defaultValue": "10.0.100.0/26"
    },
    "firewallClientSubnetServiceEndpoints": {
      "type": "array",
      "defaultValue": []
    },
    "firewallClientPublicIPAddressName": {
      "type": "string",
      "defaultValue": "firewall-client-public-ip"
    },
    "firewallClientPublicIPAddressSkuName": {
      "type": "string",
      "defaultValue": "Basic"
    },
    "firewallClientPublicIpAllocationMethod": {
      "type": "string",
      "defaultValue": "Static"
    },
    "firewallClientPublicIPAddressAvailabilityZones": {
      "type": "array",
      "defaultValue": []
    },
    "firewallManagementSubnetServiceEndpoints": {
      "type": "array",
      "defaultValue": []
    },
    "firewallManagementPublicIPAddressName": {
      "type": "string",
      "defaultValue": "firewall-management-public-ip"
    },
    "firewallManagementPublicIPAddressSkuName": {
      "type": "string",
      "defaultValue": "Basic"
    },
    "firewallManagementPublicIpAllocationMethod": {
      "type": "string",
      "defaultValue": "Static"
    },
    "firewallManagementPublicIPAddressAvailabilityZones": {
      "type": "array",
      "defaultValue": []
    },
    "identityResourceGroupName": {
      "type": "string",
      "defaultValue": "[replace(parameters('hubResourceGroupName'), 'hub', 'identity')]"
    },
    "identityLocation": {
      "type": "string",
      "defaultValue": "[parameters('hubLocation')]"
    },
    "identityVirtualNetworkName": {
      "type": "string",
      "defaultValue": "[replace(parameters('hubVirtualNetworkName'), 'hub', 'identity')]"
    },
    "identitySubnetName": {
      "type": "string",
      "defaultValue": "[replace(parameters('hubSubnetName'), 'hub', 'identity')]"
    },
    "identityVirtualNetworkAddressPrefix": {
      "type": "string",
      "defaultValue": "10.0.110.0/26"
    },
    "identitySubnetAddressPrefix": {
      "type": "string",
      "defaultValue": "10.0.110.0/27"
    },
    "identityNetworkSecurityGroupName": {
      "type": "string",
      "defaultValue": "[replace(parameters('hubNetworkSecurityGroupName'), 'hub', 'identity')]"
    },
    "identityNetworkSecurityGroupRules": {
      "type": "array",
      "defaultValue": "[parameters('hubNetworkSecurityGroupRules')]"
    },
    "identityLogStorageAccountName": {
      "type": "string",
      "defaultValue": "[toLower(take(format('idlogs{0}', parameters('uniqueId')), 24))]"
    },
    "identityLogStorageSkuName": {
      "type": "string",
      "defaultValue": "[parameters('hubLogStorageSkuName')]"
    },
    "operationsResourceGroupName": {
      "type": "string",
      "defaultValue": "[replace(parameters('hubResourceGroupName'), 'hub', 'operations')]"
    },
    "operationsLocation": {
      "type": "string",
      "defaultValue": "[parameters('hubLocation')]"
    },
    "operationsVirtualNetworkName": {
      "type": "string",
      "defaultValue": "[replace(parameters('hubVirtualNetworkName'), 'hub', 'operations')]"
    },
    "operationsVirtualNetworkAddressPrefix": {
      "type": "string",
      "defaultValue": "10.0.115.0/26"
    },
    "operationsNetworkSecurityGroupName": {
      "type": "string",
      "defaultValue": "[replace(parameters('hubNetworkSecurityGroupName'), 'hub', 'operations')]"
    },
    "operationsNetworkSecurityGroupRules": {
      "type": "array",
      "defaultValue": "[parameters('hubNetworkSecurityGroupRules')]"
    },
    "operationsSubnetName": {
      "type": "string",
      "defaultValue": "[replace(parameters('hubSubnetName'), 'hub', 'operations')]"
    },
    "operationsSubnetAddressPrefix": {
      "type": "string",
      "defaultValue": "10.0.115.0/27"
    },
    "operationsLogStorageAccountName": {
      "type": "string",
      "defaultValue": "[toLower(take(format('opslogs{0}', parameters('uniqueId')), 24))]"
    },
    "operationsLogStorageSkuName": {
      "type": "string",
      "defaultValue": "[parameters('hubLogStorageSkuName')]"
    },
    "sharedServicesResourceGroupName": {
      "type": "string",
      "defaultValue": "[replace(parameters('hubResourceGroupName'), 'hub', 'sharedServices')]"
    },
    "sharedServicesLocation": {
      "type": "string",
      "defaultValue": "[parameters('hubLocation')]"
    },
    "sharedServicesVirtualNetworkName": {
      "type": "string",
      "defaultValue": "[replace(parameters('hubVirtualNetworkName'), 'hub', 'sharedServices')]"
    },
    "sharedServicesSubnetName": {
      "type": "string",
      "defaultValue": "[replace(parameters('hubSubnetName'), 'hub', 'sharedServices')]"
    },
    "sharedServicesVirtualNetworkAddressPrefix": {
      "type": "string",
      "defaultValue": "10.0.120.0/26"
    },
    "sharedServicesSubnetAddressPrefix": {
      "type": "string",
      "defaultValue": "10.0.120.0/27"
    },
    "sharedServicesNetworkSecurityGroupName": {
      "type": "string",
      "defaultValue": "[replace(parameters('hubNetworkSecurityGroupName'), 'hub', 'sharedServices')]"
    },
    "sharedServicesNetworkSecurityGroupRules": {
      "type": "array",
      "defaultValue": "[parameters('hubNetworkSecurityGroupRules')]"
    },
    "sharedServicesLogStorageAccountName": {
      "type": "string",
      "defaultValue": "[toLower(take(format('shrdSvclogs{0}', parameters('uniqueId')), 24))]"
    },
    "sharedServicesLogStorageSkuName": {
      "type": "string",
      "defaultValue": "[parameters('hubLogStorageSkuName')]"
    },
    "deployRemoteAccess": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Provision Azure Bastion Host and jumpboxes in this deployment"
      }
    },
    "bastionHostName": {
      "type": "string",
      "defaultValue": "bastionHost"
    },
    "bastionHostSubnetAddressPrefix": {
      "type": "string",
      "defaultValue": "10.0.100.160/27"
    },
    "bastionHostPublicIPAddressName": {
      "type": "string",
      "defaultValue": "bastionHostPublicIPAddress"
    },
    "bastionHostPublicIPAddressSkuName": {
      "type": "string",
      "defaultValue": "Standard"
    },
    "bastionHostPublicIPAddressAllocationMethod": {
      "type": "string",
      "defaultValue": "Static"
    },
    "bastionHostPublicIPAddressAvailabilityZones": {
      "type": "array",
      "defaultValue": []
    },
    "bastionHostIPConfigurationName": {
      "type": "string",
      "defaultValue": "bastionHostIPConfiguration"
    },
    "linuxNetworkInterfaceName": {
      "type": "string",
      "defaultValue": "linuxVmNetworkInterface"
    },
    "linuxNetworkInterfaceIpConfigurationName": {
      "type": "string",
      "defaultValue": "linuxVmIpConfiguration"
    },
    "linuxNetworkInterfacePrivateIPAddressAllocationMethod": {
      "type": "string",
      "defaultValue": "Dynamic"
    },
    "linuxVmName": {
      "type": "string",
      "defaultValue": "linuxVirtualMachine"
    },
    "linuxVmSize": {
      "type": "string",
      "defaultValue": "Standard_B2s"
    },
    "linuxVmOsDiskCreateOption": {
      "type": "string",
      "defaultValue": "FromImage"
    },
    "linuxVmOsDiskType": {
      "type": "string",
      "defaultValue": "Standard_LRS"
    },
    "linuxVmImagePublisher": {
      "type": "string",
      "defaultValue": "Canonical"
    },
    "linuxVmImageOffer": {
      "type": "string",
      "defaultValue": "UbuntuServer"
    },
    "linuxVmImageSku": {
      "type": "string",
      "defaultValue": "18.04-LTS"
    },
    "linuxVmImageVersion": {
      "type": "string",
      "defaultValue": "latest"
    },
    "linuxVmAdminUsername": {
      "type": "string",
      "defaultValue": "azureuser"
    },
    "linuxVmAuthenticationType": {
      "type": "string",
      "defaultValue": "password",
      "allowedValues": [
        "sshPublicKey",
        "password"
      ]
    },
    "linuxVmAdminPasswordOrKey": {
      "type": "secureString",
      "defaultValue": "[if(parameters('deployRemoteAccess'), '', newGuid())]",
      "minLength": 14
    },
    "windowsNetworkInterfaceName": {
      "type": "string",
      "defaultValue": "windowsVmNetworkInterface"
    },
    "windowsNetworkInterfaceIpConfigurationName": {
      "type": "string",
      "defaultValue": "windowsVmIpConfiguration"
    },
    "windowsNetworkInterfacePrivateIPAddressAllocationMethod": {
      "type": "string",
      "defaultValue": "Dynamic"
    },
    "windowsVmName": {
      "type": "string",
      "defaultValue": "windowsVm"
    },
    "windowsVmSize": {
      "type": "string",
      "defaultValue": "Standard_DS1_v2"
    },
    "windowsVmAdminUsername": {
      "type": "string",
      "defaultValue": "azureuser"
    },
    "windowsVmAdminPassword": {
      "type": "secureString",
      "defaultValue": "[if(parameters('deployRemoteAccess'), '', newGuid())]",
      "minLength": 14
    },
    "windowsVmPublisher": {
      "type": "string",
      "defaultValue": "MicrosoftWindowsServer"
    },
    "windowsVmOffer": {
      "type": "string",
      "defaultValue": "WindowsServer"
    },
    "windowsVmSku": {
      "type": "string",
      "defaultValue": "2019-datacenter"
    },
    "windowsVmVersion": {
      "type": "string",
      "defaultValue": "latest"
    },
    "windowsVmCreateOption": {
      "type": "string",
      "defaultValue": "FromImage"
    },
    "windowsVmStorageAccountType": {
      "type": "string",
      "defaultValue": "StandardSSD_LRS"
    },
    "tags": {
      "type": "object",
      "defaultValue": {
        "resourcePrefix": "[parameters('resourcePrefix')]",
        "DeploymentType": "MissionLandingZoneARM"
      }
    },
    "uniqueId": {
      "type": "string",
      "defaultValue": "[uniqueString(deployment().name)]"
    },
    "nowUtc": {
      "type": "string",
      "defaultValue": "[utcNow()]"
    }
  },
  "functions": [],
  "variables": {
    "firewallClientSubnetName": "AzureFirewallSubnet",
    "firewallManagementSubnetName": "AzureFirewallManagementSubnet"
  },
  "resources": [
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-06-01",
      "name": "[format('deploy-hub-rg-{0}', parameters('nowUtc'))]",
      "location": "[deployment().location]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "name": {
            "value": "[parameters('hubResourceGroupName')]"
          },
          "location": {
            "value": "[parameters('hubLocation')]"
          },
          "tags": {
            "value": "[parameters('tags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.4.1008.15138",
              "templateHash": "16804784914647536968"
            }
          },
          "parameters": {
            "name": {
              "type": "string"
            },
            "location": {
              "type": "string"
            },
            "tags": {
              "type": "object",
              "defaultValue": {}
            }
          },
          "functions": [],
          "resources": [
            {
              "type": "Microsoft.Resources/resourceGroups",
              "apiVersion": "2019-05-01",
              "name": "[parameters('name')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]"
            }
          ],
          "outputs": {
            "id": {
              "type": "string",
              "value": "[subscriptionResourceId('Microsoft.Resources/resourceGroups', parameters('name'))]"
            },
            "name": {
              "type": "string",
              "value": "[parameters('name')]"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-06-01",
      "name": "[format('deploy-identity-rg-{0}', parameters('nowUtc'))]",
      "location": "[deployment().location]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "name": {
            "value": "[parameters('identityResourceGroupName')]"
          },
          "location": {
            "value": "[parameters('identityLocation')]"
          },
          "tags": {
            "value": "[parameters('tags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.4.1008.15138",
              "templateHash": "16804784914647536968"
            }
          },
          "parameters": {
            "name": {
              "type": "string"
            },
            "location": {
              "type": "string"
            },
            "tags": {
              "type": "object",
              "defaultValue": {}
            }
          },
          "functions": [],
          "resources": [
            {
              "type": "Microsoft.Resources/resourceGroups",
              "apiVersion": "2019-05-01",
              "name": "[parameters('name')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]"
            }
          ],
          "outputs": {
            "id": {
              "type": "string",
              "value": "[subscriptionResourceId('Microsoft.Resources/resourceGroups', parameters('name'))]"
            },
            "name": {
              "type": "string",
              "value": "[parameters('name')]"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-06-01",
      "name": "[format('deploy-operations-rg-{0}', parameters('nowUtc'))]",
      "location": "[deployment().location]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "name": {
            "value": "[parameters('operationsResourceGroupName')]"
          },
          "location": {
            "value": "[parameters('operationsLocation')]"
          },
          "tags": {
            "value": "[parameters('tags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.4.1008.15138",
              "templateHash": "16804784914647536968"
            }
          },
          "parameters": {
            "name": {
              "type": "string"
            },
            "location": {
              "type": "string"
            },
            "tags": {
              "type": "object",
              "defaultValue": {}
            }
          },
          "functions": [],
          "resources": [
            {
              "type": "Microsoft.Resources/resourceGroups",
              "apiVersion": "2019-05-01",
              "name": "[parameters('name')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]"
            }
          ],
          "outputs": {
            "id": {
              "type": "string",
              "value": "[subscriptionResourceId('Microsoft.Resources/resourceGroups', parameters('name'))]"
            },
            "name": {
              "type": "string",
              "value": "[parameters('name')]"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-06-01",
      "name": "[format('deploy-sharedServices-rg-{0}', parameters('nowUtc'))]",
      "location": "[deployment().location]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "name": {
            "value": "[parameters('sharedServicesResourceGroupName')]"
          },
          "location": {
            "value": "[parameters('sharedServicesLocation')]"
          },
          "tags": {
            "value": "[parameters('tags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.4.1008.15138",
              "templateHash": "16804784914647536968"
            }
          },
          "parameters": {
            "name": {
              "type": "string"
            },
            "location": {
              "type": "string"
            },
            "tags": {
              "type": "object",
              "defaultValue": {}
            }
          },
          "functions": [],
          "resources": [
            {
              "type": "Microsoft.Resources/resourceGroups",
              "apiVersion": "2019-05-01",
              "name": "[parameters('name')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]"
            }
          ],
          "outputs": {
            "id": {
              "type": "string",
              "value": "[subscriptionResourceId('Microsoft.Resources/resourceGroups', parameters('name'))]"
            },
            "name": {
              "type": "string",
              "value": "[parameters('name')]"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-06-01",
      "name": "[format('deploy-hub-{0}', parameters('nowUtc'))]",
      "resourceGroup": "[parameters('hubResourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('hubLocation')]"
          },
          "tags": {
            "value": "[parameters('tags')]"
          },
          "logStorageAccountName": {
            "value": "[parameters('hubLogStorageAccountName')]"
          },
          "logStorageSkuName": {
            "value": "[parameters('hubLogStorageSkuName')]"
          },
          "virtualNetworkName": {
            "value": "[parameters('hubVirtualNetworkName')]"
          },
          "virtualNetworkAddressPrefix": {
            "value": "[parameters('hubVirtualNetworkAddressPrefix')]"
          },
          "networkSecurityGroupName": {
            "value": "[parameters('hubNetworkSecurityGroupName')]"
          },
          "networkSecurityGroupRules": {
            "value": "[parameters('hubNetworkSecurityGroupRules')]"
          },
          "subnetName": {
            "value": "[parameters('hubSubnetName')]"
          },
          "subnetAddressPrefix": {
            "value": "[parameters('hubSubnetAddressPrefix')]"
          },
          "firewallClientSubnetName": {
            "value": "[variables('firewallClientSubnetName')]"
          },
          "firewallClientSubnetAddressPrefix": {
            "value": "[parameters('firewallClientSubnetAddressPrefix')]"
          },
          "firewallClientSubnetServiceEndpoints": {
            "value": "[parameters('firewallClientSubnetServiceEndpoints')]"
          },
          "firewallClientPublicIPAddressName": {
            "value": "[parameters('firewallClientPublicIPAddressName')]"
          },
          "firewallClientPublicIPAddressSkuName": {
            "value": "[parameters('firewallClientPublicIPAddressSkuName')]"
          },
          "firewallClientPublicIpAllocationMethod": {
            "value": "[parameters('firewallClientPublicIpAllocationMethod')]"
          },
          "firewallClientPublicIPAddressAvailabilityZones": {
            "value": "[parameters('firewallClientPublicIPAddressAvailabilityZones')]"
          },
          "firewallManagementSubnetName": {
            "value": "[variables('firewallManagementSubnetName')]"
          },
          "firewallManagementSubnetAddressPrefix": {
            "value": "[parameters('firewallManagementSubnetAddressPrefix')]"
          },
          "firewallManagementSubnetServiceEndpoints": {
            "value": "[parameters('firewallManagementSubnetServiceEndpoints')]"
          },
          "firewallManagementPublicIPAddressName": {
            "value": "[parameters('firewallManagementPublicIPAddressName')]"
          },
          "firewallManagementPublicIPAddressSkuName": {
            "value": "[parameters('firewallManagementPublicIPAddressSkuName')]"
          },
          "firewallManagementPublicIpAllocationMethod": {
            "value": "[parameters('firewallManagementPublicIpAllocationMethod')]"
          },
          "firewallManagementPublicIPAddressAvailabilityZones": {
            "value": "[parameters('firewallManagementPublicIPAddressAvailabilityZones')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.4.1008.15138",
              "templateHash": "6376236681920027775"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]"
            },
            "tags": {
              "type": "object",
              "defaultValue": {}
            },
            "logStorageAccountName": {
              "type": "string"
            },
            "logStorageSkuName": {
              "type": "string"
            },
            "virtualNetworkName": {
              "type": "string"
            },
            "virtualNetworkAddressPrefix": {
              "type": "string"
            },
            "networkSecurityGroupName": {
              "type": "string"
            },
            "networkSecurityGroupRules": {
              "type": "array"
            },
            "subnetName": {
              "type": "string"
            },
            "subnetAddressPrefix": {
              "type": "string"
            },
            "routeTableName": {
              "type": "string",
              "defaultValue": "[format('{0}-routetable', parameters('subnetName'))]"
            },
            "routeTableRouteName": {
              "type": "string",
              "defaultValue": "default_route"
            },
            "routeTableRouteAddressPrefix": {
              "type": "string",
              "defaultValue": "0.0.0.0/0"
            },
            "routeTableRouteNextHopType": {
              "type": "string",
              "defaultValue": "VirtualAppliance"
            },
            "firewallClientSubnetName": {
              "type": "string"
            },
            "firewallClientSubnetAddressPrefix": {
              "type": "string"
            },
            "firewallClientSubnetServiceEndpoints": {
              "type": "array"
            },
            "firewallClientPublicIPAddressName": {
              "type": "string"
            },
            "firewallClientPublicIPAddressSkuName": {
              "type": "string"
            },
            "firewallClientPublicIpAllocationMethod": {
              "type": "string"
            },
            "firewallClientPublicIPAddressAvailabilityZones": {
              "type": "array"
            },
            "firewallManagementSubnetName": {
              "type": "string"
            },
            "firewallManagementSubnetAddressPrefix": {
              "type": "string"
            },
            "firewallManagementSubnetServiceEndpoints": {
              "type": "array"
            },
            "firewallManagementPublicIPAddressName": {
              "type": "string"
            },
            "firewallManagementPublicIPAddressSkuName": {
              "type": "string"
            },
            "firewallManagementPublicIpAllocationMethod": {
              "type": "string"
            },
            "firewallManagementPublicIPAddressAvailabilityZones": {
              "type": "array"
            }
          },
          "functions": [],
          "resources": [
            {
              "type": "Microsoft.Network/virtualNetworks/subnets",
              "apiVersion": "2018-11-01",
              "name": "[format('{0}/{1}', parameters('virtualNetworkName'), parameters('subnetName'))]",
              "properties": {
                "addressPrefix": "[parameters('subnetAddressPrefix')]",
                "networkSecurityGroup": {
                  "id": "[reference(resourceId('Microsoft.Resources/deployments', 'networkSecurityGroup'), '2020-06-01').outputs.id.value]"
                },
                "routeTable": {
                  "id": "[reference(resourceId('Microsoft.Resources/deployments', 'routeTable'), '2020-06-01').outputs.id.value]"
                },
                "privateEndpointNetworkPolicies": "Disabled",
                "privateLinkServiceNetworkPolicies": "Enabled"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', 'networkSecurityGroup')]",
                "[resourceId('Microsoft.Resources/deployments', 'routeTable')]",
                "[resourceId('Microsoft.Resources/deployments', 'virtualNetwork')]"
              ]
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-06-01",
              "name": "logStorage",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "storageAccountName": {
                    "value": "[parameters('logStorageAccountName')]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "skuName": {
                    "value": "[parameters('logStorageSkuName')]"
                  },
                  "tags": {
                    "value": "[parameters('tags')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.1008.15138",
                      "templateHash": "779275696574787628"
                    }
                  },
                  "parameters": {
                    "storageAccountName": {
                      "type": "string"
                    },
                    "location": {
                      "type": "string"
                    },
                    "skuName": {
                      "type": "string"
                    },
                    "tags": {
                      "type": "object",
                      "defaultValue": {}
                    }
                  },
                  "functions": [],
                  "resources": [
                    {
                      "type": "Microsoft.Storage/storageAccounts",
                      "apiVersion": "2019-06-01",
                      "name": "[parameters('storageAccountName')]",
                      "location": "[parameters('location')]",
                      "kind": "Storage",
                      "sku": {
                        "name": "[parameters('skuName')]"
                      },
                      "tags": "[parameters('tags')]"
                    }
                  ],
                  "outputs": {
                    "id": {
                      "type": "string",
                      "value": "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName'))]"
                    }
                  }
                }
              }
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-06-01",
              "name": "networkSecurityGroup",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "name": {
                    "value": "[parameters('networkSecurityGroupName')]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "tags": {
                    "value": "[parameters('tags')]"
                  },
                  "securityRules": {
                    "value": "[parameters('networkSecurityGroupRules')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.1008.15138",
                      "templateHash": "17850607432557549000"
                    }
                  },
                  "parameters": {
                    "name": {
                      "type": "string"
                    },
                    "location": {
                      "type": "string"
                    },
                    "tags": {
                      "type": "object",
                      "defaultValue": {}
                    },
                    "securityRules": {
                      "type": "array"
                    }
                  },
                  "functions": [],
                  "resources": [
                    {
                      "type": "Microsoft.Network/networkSecurityGroups",
                      "apiVersion": "2018-11-01",
                      "name": "[parameters('name')]",
                      "location": "[parameters('location')]",
                      "tags": "[parameters('tags')]",
                      "properties": {
                        "securityRules": "[parameters('securityRules')]"
                      }
                    }
                  ],
                  "outputs": {
                    "id": {
                      "type": "string",
                      "value": "[resourceId('Microsoft.Network/networkSecurityGroups', parameters('name'))]"
                    },
                    "name": {
                      "type": "string",
                      "value": "[parameters('name')]"
                    }
                  }
                }
              }
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-06-01",
              "name": "virtualNetwork",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "name": {
                    "value": "[parameters('virtualNetworkName')]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "tags": {
                    "value": "[parameters('tags')]"
                  },
                  "addressPrefix": {
                    "value": "[parameters('virtualNetworkAddressPrefix')]"
                  },
                  "subnets": {
                    "value": [
                      {
                        "name": "[parameters('firewallClientSubnetName')]",
                        "properties": {
                          "addressPrefix": "[parameters('firewallClientSubnetAddressPrefix')]",
                          "serviceEndpoints": "[parameters('firewallClientSubnetServiceEndpoints')]"
                        }
                      },
                      {
                        "name": "[parameters('firewallManagementSubnetName')]",
                        "properties": {
                          "addressPrefix": "[parameters('firewallManagementSubnetAddressPrefix')]",
                          "serviceEndpoints": "[parameters('firewallManagementSubnetServiceEndpoints')]"
                        }
                      }
                    ]
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.1008.15138",
                      "templateHash": "4423030218172085734"
                    }
                  },
                  "parameters": {
                    "name": {
                      "type": "string"
                    },
                    "location": {
                      "type": "string"
                    },
                    "tags": {
                      "type": "object",
                      "defaultValue": {}
                    },
                    "addressPrefix": {
                      "type": "string"
                    },
                    "subnets": {
                      "type": "array"
                    }
                  },
                  "functions": [],
                  "resources": [
                    {
                      "type": "Microsoft.Network/virtualNetworks",
                      "apiVersion": "2018-11-01",
                      "name": "[parameters('name')]",
                      "location": "[parameters('location')]",
                      "tags": "[parameters('tags')]",
                      "properties": {
                        "addressSpace": {
                          "addressPrefixes": [
                            "[parameters('addressPrefix')]"
                          ]
                        },
                        "subnets": "[parameters('subnets')]"
                      }
                    }
                  ],
                  "outputs": {
                    "name": {
                      "type": "string",
                      "value": "[parameters('name')]"
                    },
                    "id": {
                      "type": "string",
                      "value": "[resourceId('Microsoft.Network/virtualNetworks', parameters('name'))]"
                    },
                    "subnets": {
                      "type": "array",
                      "value": "[reference(resourceId('Microsoft.Network/virtualNetworks', parameters('name'))).subnets]"
                    }
                  }
                }
              }
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-06-01",
              "name": "routeTable",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "name": {
                    "value": "[parameters('routeTableName')]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "tags": {
                    "value": "[parameters('tags')]"
                  },
                  "routeName": {
                    "value": "[parameters('routeTableRouteName')]"
                  },
                  "routeAddressPrefix": {
                    "value": "[parameters('routeTableRouteAddressPrefix')]"
                  },
                  "routeNextHopIpAddress": {
                    "value": "10.0.100.4"
                  },
                  "routeNextHopType": {
                    "value": "[parameters('routeTableRouteNextHopType')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.1008.15138",
                      "templateHash": "5972748863454844401"
                    }
                  },
                  "parameters": {
                    "name": {
                      "type": "string"
                    },
                    "location": {
                      "type": "string"
                    },
                    "tags": {
                      "type": "object",
                      "defaultValue": {}
                    },
                    "routeName": {
                      "type": "string"
                    },
                    "routeAddressPrefix": {
                      "type": "string"
                    },
                    "routeNextHopIpAddress": {
                      "type": "string"
                    },
                    "routeNextHopType": {
                      "type": "string"
                    }
                  },
                  "functions": [],
                  "resources": [
                    {
                      "type": "Microsoft.Network/routeTables",
                      "apiVersion": "2018-11-01",
                      "name": "[parameters('name')]",
                      "location": "[parameters('location')]",
                      "tags": "[parameters('tags')]",
                      "properties": {
                        "routes": [
                          {
                            "name": "[parameters('routeName')]",
                            "properties": {
                              "addressPrefix": "[parameters('routeAddressPrefix')]",
                              "nextHopIpAddress": "[parameters('routeNextHopIpAddress')]",
                              "nextHopType": "[parameters('routeNextHopType')]"
                            }
                          }
                        ]
                      }
                    }
                  ],
                  "outputs": {
                    "id": {
                      "type": "string",
                      "value": "[resourceId('Microsoft.Network/routeTables', parameters('name'))]"
                    },
                    "name": {
                      "type": "string",
                      "value": "[parameters('name')]"
                    }
                  }
                }
              }
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-06-01",
              "name": "firewallClientPublicIPAddress",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "name": {
                    "value": "[parameters('firewallClientPublicIPAddressName')]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "tags": {
                    "value": "[parameters('tags')]"
                  },
                  "skuName": {
                    "value": "[parameters('firewallClientPublicIPAddressSkuName')]"
                  },
                  "publicIpAllocationMethod": {
                    "value": "[parameters('firewallClientPublicIpAllocationMethod')]"
                  },
                  "availabilityZones": {
                    "value": "[parameters('firewallClientPublicIPAddressAvailabilityZones')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.1008.15138",
                      "templateHash": "17570476208535829638"
                    }
                  },
                  "parameters": {
                    "name": {
                      "type": "string"
                    },
                    "location": {
                      "type": "string"
                    },
                    "tags": {
                      "type": "object",
                      "defaultValue": {}
                    },
                    "skuName": {
                      "type": "string"
                    },
                    "publicIpAllocationMethod": {
                      "type": "string"
                    },
                    "availabilityZones": {
                      "type": "array"
                    }
                  },
                  "functions": [],
                  "resources": [
                    {
                      "type": "Microsoft.Network/publicIPAddresses",
                      "apiVersion": "2018-11-01",
                      "name": "[parameters('name')]",
                      "location": "[parameters('location')]",
                      "tags": "[parameters('tags')]",
                      "sku": {
                        "name": "[parameters('skuName')]"
                      },
                      "properties": {
                        "publicIPAllocationMethod": "[parameters('publicIpAllocationMethod')]"
                      },
                      "zones": "[parameters('availabilityZones')]"
                    }
                  ],
                  "outputs": {
                    "id": {
                      "type": "string",
                      "value": "[resourceId('Microsoft.Network/publicIPAddresses', parameters('name'))]"
                    }
                  }
                }
              }
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-06-01",
              "name": "firewallManagementPublicIPAddress",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "name": {
                    "value": "[parameters('firewallManagementPublicIPAddressName')]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "tags": {
                    "value": "[parameters('tags')]"
                  },
                  "skuName": {
                    "value": "[parameters('firewallManagementPublicIPAddressSkuName')]"
                  },
                  "publicIpAllocationMethod": {
                    "value": "[parameters('firewallManagementPublicIpAllocationMethod')]"
                  },
                  "availabilityZones": {
                    "value": "[parameters('firewallManagementPublicIPAddressAvailabilityZones')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.1008.15138",
                      "templateHash": "17570476208535829638"
                    }
                  },
                  "parameters": {
                    "name": {
                      "type": "string"
                    },
                    "location": {
                      "type": "string"
                    },
                    "tags": {
                      "type": "object",
                      "defaultValue": {}
                    },
                    "skuName": {
                      "type": "string"
                    },
                    "publicIpAllocationMethod": {
                      "type": "string"
                    },
                    "availabilityZones": {
                      "type": "array"
                    }
                  },
                  "functions": [],
                  "resources": [
                    {
                      "type": "Microsoft.Network/publicIPAddresses",
                      "apiVersion": "2018-11-01",
                      "name": "[parameters('name')]",
                      "location": "[parameters('location')]",
                      "tags": "[parameters('tags')]",
                      "sku": {
                        "name": "[parameters('skuName')]"
                      },
                      "properties": {
                        "publicIPAllocationMethod": "[parameters('publicIpAllocationMethod')]"
                      },
                      "zones": "[parameters('availabilityZones')]"
                    }
                  ],
                  "outputs": {
                    "id": {
                      "type": "string",
                      "value": "[resourceId('Microsoft.Network/publicIPAddresses', parameters('name'))]"
                    }
                  }
                }
              }
            }
          ],
          "outputs": {
            "virtualNetworkName": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Resources/deployments', 'virtualNetwork'), '2020-06-01').outputs.name.value]"
            },
            "virtualNetworkResourceId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Resources/deployments', 'virtualNetwork'), '2020-06-01').outputs.id.value]"
            },
            "subnetName": {
              "type": "string",
              "value": "[format('{0}/{1}', parameters('virtualNetworkName'), parameters('subnetName'))]"
            },
            "subnetAddressPrefix": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Network/virtualNetworks/subnets', split(format('{0}/{1}', parameters('virtualNetworkName'), parameters('subnetName')), '/')[0], split(format('{0}/{1}', parameters('virtualNetworkName'), parameters('subnetName')), '/')[1])).addressPrefix]"
            },
            "subnetResourceId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Network/virtualNetworks/subnets', split(format('{0}/{1}', parameters('virtualNetworkName'), parameters('subnetName')), '/')[0], split(format('{0}/{1}', parameters('virtualNetworkName'), parameters('subnetName')), '/')[1])]"
            },
            "networkSecurityGroupName": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Resources/deployments', 'networkSecurityGroup'), '2020-06-01').outputs.name.value]"
            },
            "networkSecurityGroupResourceId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Resources/deployments', 'networkSecurityGroup'), '2020-06-01').outputs.id.value]"
            }
          }
        }
      },
      "dependsOn": [
        "[subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-hub-rg-{0}', parameters('nowUtc')))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-06-01",
      "name": "[format('deploy-identity-spoke-{0}', parameters('nowUtc'))]",
      "resourceGroup": "[parameters('identityResourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('identityLocation')]"
          },
          "tags": {
            "value": "[parameters('tags')]"
          },
          "logStorageAccountName": {
            "value": "[parameters('identityLogStorageAccountName')]"
          },
          "logStorageSkuName": {
            "value": "[parameters('identityLogStorageSkuName')]"
          },
          "firewallPrivateIPAddress": {
            "value": "10.0.100.4"
          },
          "virtualNetworkName": {
            "value": "[parameters('identityVirtualNetworkName')]"
          },
          "virtualNetworkAddressPrefix": {
            "value": "[parameters('identityVirtualNetworkAddressPrefix')]"
          },
          "networkSecurityGroupName": {
            "value": "[parameters('identityNetworkSecurityGroupName')]"
          },
          "networkSecurityGroupRules": {
            "value": "[parameters('identityNetworkSecurityGroupRules')]"
          },
          "subnetName": {
            "value": "[parameters('identitySubnetName')]"
          },
          "subnetAddressPrefix": {
            "value": "[parameters('identitySubnetAddressPrefix')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.4.1008.15138",
              "templateHash": "3095237861841650734"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]"
            },
            "tags": {
              "type": "object",
              "defaultValue": {}
            },
            "logStorageAccountName": {
              "type": "string"
            },
            "logStorageSkuName": {
              "type": "string"
            },
            "firewallPrivateIPAddress": {
              "type": "string"
            },
            "virtualNetworkName": {
              "type": "string"
            },
            "virtualNetworkAddressPrefix": {
              "type": "string"
            },
            "networkSecurityGroupName": {
              "type": "string"
            },
            "networkSecurityGroupRules": {
              "type": "array"
            },
            "subnetName": {
              "type": "string"
            },
            "subnetAddressPrefix": {
              "type": "string"
            },
            "routeTableName": {
              "type": "string",
              "defaultValue": "[format('{0}-routetable', parameters('subnetName'))]"
            },
            "routeTableRouteName": {
              "type": "string",
              "defaultValue": "default_route"
            },
            "routeTableRouteAddressPrefix": {
              "type": "string",
              "defaultValue": "0.0.0.0/0"
            },
            "routeTableRouteNextHopIpAddress": {
              "type": "string",
              "defaultValue": "[parameters('firewallPrivateIPAddress')]"
            },
            "routeTableRouteNextHopType": {
              "type": "string",
              "defaultValue": "VirtualAppliance"
            }
          },
          "functions": [],
          "resources": [
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-06-01",
              "name": "logStorage",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "storageAccountName": {
                    "value": "[parameters('logStorageAccountName')]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "skuName": {
                    "value": "[parameters('logStorageSkuName')]"
                  },
                  "tags": {
                    "value": "[parameters('tags')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.1008.15138",
                      "templateHash": "779275696574787628"
                    }
                  },
                  "parameters": {
                    "storageAccountName": {
                      "type": "string"
                    },
                    "location": {
                      "type": "string"
                    },
                    "skuName": {
                      "type": "string"
                    },
                    "tags": {
                      "type": "object",
                      "defaultValue": {}
                    }
                  },
                  "functions": [],
                  "resources": [
                    {
                      "type": "Microsoft.Storage/storageAccounts",
                      "apiVersion": "2019-06-01",
                      "name": "[parameters('storageAccountName')]",
                      "location": "[parameters('location')]",
                      "kind": "Storage",
                      "sku": {
                        "name": "[parameters('skuName')]"
                      },
                      "tags": "[parameters('tags')]"
                    }
                  ],
                  "outputs": {
                    "id": {
                      "type": "string",
                      "value": "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName'))]"
                    }
                  }
                }
              }
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-06-01",
              "name": "networkSecurityGroup",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "name": {
                    "value": "[parameters('networkSecurityGroupName')]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "tags": {
                    "value": "[parameters('tags')]"
                  },
                  "securityRules": {
                    "value": "[parameters('networkSecurityGroupRules')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.1008.15138",
                      "templateHash": "17850607432557549000"
                    }
                  },
                  "parameters": {
                    "name": {
                      "type": "string"
                    },
                    "location": {
                      "type": "string"
                    },
                    "tags": {
                      "type": "object",
                      "defaultValue": {}
                    },
                    "securityRules": {
                      "type": "array"
                    }
                  },
                  "functions": [],
                  "resources": [
                    {
                      "type": "Microsoft.Network/networkSecurityGroups",
                      "apiVersion": "2018-11-01",
                      "name": "[parameters('name')]",
                      "location": "[parameters('location')]",
                      "tags": "[parameters('tags')]",
                      "properties": {
                        "securityRules": "[parameters('securityRules')]"
                      }
                    }
                  ],
                  "outputs": {
                    "id": {
                      "type": "string",
                      "value": "[resourceId('Microsoft.Network/networkSecurityGroups', parameters('name'))]"
                    },
                    "name": {
                      "type": "string",
                      "value": "[parameters('name')]"
                    }
                  }
                }
              }
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-06-01",
              "name": "routeTable",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "name": {
                    "value": "[parameters('routeTableName')]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "tags": {
                    "value": "[parameters('tags')]"
                  },
                  "routeName": {
                    "value": "[parameters('routeTableRouteName')]"
                  },
                  "routeAddressPrefix": {
                    "value": "[parameters('routeTableRouteAddressPrefix')]"
                  },
                  "routeNextHopIpAddress": {
                    "value": "[parameters('routeTableRouteNextHopIpAddress')]"
                  },
                  "routeNextHopType": {
                    "value": "[parameters('routeTableRouteNextHopType')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.1008.15138",
                      "templateHash": "5972748863454844401"
                    }
                  },
                  "parameters": {
                    "name": {
                      "type": "string"
                    },
                    "location": {
                      "type": "string"
                    },
                    "tags": {
                      "type": "object",
                      "defaultValue": {}
                    },
                    "routeName": {
                      "type": "string"
                    },
                    "routeAddressPrefix": {
                      "type": "string"
                    },
                    "routeNextHopIpAddress": {
                      "type": "string"
                    },
                    "routeNextHopType": {
                      "type": "string"
                    }
                  },
                  "functions": [],
                  "resources": [
                    {
                      "type": "Microsoft.Network/routeTables",
                      "apiVersion": "2018-11-01",
                      "name": "[parameters('name')]",
                      "location": "[parameters('location')]",
                      "tags": "[parameters('tags')]",
                      "properties": {
                        "routes": [
                          {
                            "name": "[parameters('routeName')]",
                            "properties": {
                              "addressPrefix": "[parameters('routeAddressPrefix')]",
                              "nextHopIpAddress": "[parameters('routeNextHopIpAddress')]",
                              "nextHopType": "[parameters('routeNextHopType')]"
                            }
                          }
                        ]
                      }
                    }
                  ],
                  "outputs": {
                    "id": {
                      "type": "string",
                      "value": "[resourceId('Microsoft.Network/routeTables', parameters('name'))]"
                    },
                    "name": {
                      "type": "string",
                      "value": "[parameters('name')]"
                    }
                  }
                }
              }
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-06-01",
              "name": "virtualNetwork",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "name": {
                    "value": "[parameters('virtualNetworkName')]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "tags": {
                    "value": "[parameters('tags')]"
                  },
                  "addressPrefix": {
                    "value": "[parameters('virtualNetworkAddressPrefix')]"
                  },
                  "subnets": {
                    "value": [
                      {
                        "name": "[parameters('subnetName')]",
                        "properties": {
                          "addressPrefix": "[parameters('subnetAddressPrefix')]",
                          "networkSecurityGroup": {
                            "id": "[reference(resourceId('Microsoft.Resources/deployments', 'networkSecurityGroup'), '2020-06-01').outputs.id.value]"
                          },
                          "routeTable": {
                            "id": "[reference(resourceId('Microsoft.Resources/deployments', 'routeTable'), '2020-06-01').outputs.id.value]"
                          }
                        }
                      }
                    ]
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.1008.15138",
                      "templateHash": "4423030218172085734"
                    }
                  },
                  "parameters": {
                    "name": {
                      "type": "string"
                    },
                    "location": {
                      "type": "string"
                    },
                    "tags": {
                      "type": "object",
                      "defaultValue": {}
                    },
                    "addressPrefix": {
                      "type": "string"
                    },
                    "subnets": {
                      "type": "array"
                    }
                  },
                  "functions": [],
                  "resources": [
                    {
                      "type": "Microsoft.Network/virtualNetworks",
                      "apiVersion": "2018-11-01",
                      "name": "[parameters('name')]",
                      "location": "[parameters('location')]",
                      "tags": "[parameters('tags')]",
                      "properties": {
                        "addressSpace": {
                          "addressPrefixes": [
                            "[parameters('addressPrefix')]"
                          ]
                        },
                        "subnets": "[parameters('subnets')]"
                      }
                    }
                  ],
                  "outputs": {
                    "name": {
                      "type": "string",
                      "value": "[parameters('name')]"
                    },
                    "id": {
                      "type": "string",
                      "value": "[resourceId('Microsoft.Network/virtualNetworks', parameters('name'))]"
                    },
                    "subnets": {
                      "type": "array",
                      "value": "[reference(resourceId('Microsoft.Network/virtualNetworks', parameters('name'))).subnets]"
                    }
                  }
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', 'networkSecurityGroup')]",
                "[resourceId('Microsoft.Resources/deployments', 'routeTable')]"
              ]
            }
          ],
          "outputs": {
            "virtualNetworkName": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Resources/deployments', 'virtualNetwork'), '2020-06-01').outputs.name.value]"
            },
            "virtualNetworkResourceId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Resources/deployments', 'virtualNetwork'), '2020-06-01').outputs.id.value]"
            },
            "subnetName": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Resources/deployments', 'virtualNetwork'), '2020-06-01').outputs.subnets.value[0].name]"
            },
            "subnetAddressPrefix": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Resources/deployments', 'virtualNetwork'), '2020-06-01').outputs.subnets.value[0].properties.addressPrefix]"
            },
            "subnetResourceId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Resources/deployments', 'virtualNetwork'), '2020-06-01').outputs.subnets.value[0].id]"
            },
            "networkSecurityGroupName": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Resources/deployments', 'networkSecurityGroup'), '2020-06-01').outputs.name.value]"
            },
            "networkSecurityGroupResourceId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Resources/deployments', 'networkSecurityGroup'), '2020-06-01').outputs.id.value]"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-06-01",
      "name": "[format('deploy-operations-spoke-{0}', parameters('nowUtc'))]",
      "resourceGroup": "[parameters('operationsResourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('operationsLocation')]"
          },
          "tags": {
            "value": "[parameters('tags')]"
          },
          "logStorageAccountName": {
            "value": "[parameters('operationsLogStorageAccountName')]"
          },
          "logStorageSkuName": {
            "value": "[parameters('operationsLogStorageSkuName')]"
          },
          "firewallPrivateIPAddress": {
            "value": "10.0.100.4"
          },
          "virtualNetworkName": {
            "value": "[parameters('operationsVirtualNetworkName')]"
          },
          "virtualNetworkAddressPrefix": {
            "value": "[parameters('operationsVirtualNetworkAddressPrefix')]"
          },
          "networkSecurityGroupName": {
            "value": "[parameters('operationsNetworkSecurityGroupName')]"
          },
          "networkSecurityGroupRules": {
            "value": "[parameters('operationsNetworkSecurityGroupRules')]"
          },
          "subnetName": {
            "value": "[parameters('operationsSubnetName')]"
          },
          "subnetAddressPrefix": {
            "value": "[parameters('operationsSubnetAddressPrefix')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.4.1008.15138",
              "templateHash": "3095237861841650734"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]"
            },
            "tags": {
              "type": "object",
              "defaultValue": {}
            },
            "logStorageAccountName": {
              "type": "string"
            },
            "logStorageSkuName": {
              "type": "string"
            },
            "firewallPrivateIPAddress": {
              "type": "string"
            },
            "virtualNetworkName": {
              "type": "string"
            },
            "virtualNetworkAddressPrefix": {
              "type": "string"
            },
            "networkSecurityGroupName": {
              "type": "string"
            },
            "networkSecurityGroupRules": {
              "type": "array"
            },
            "subnetName": {
              "type": "string"
            },
            "subnetAddressPrefix": {
              "type": "string"
            },
            "routeTableName": {
              "type": "string",
              "defaultValue": "[format('{0}-routetable', parameters('subnetName'))]"
            },
            "routeTableRouteName": {
              "type": "string",
              "defaultValue": "default_route"
            },
            "routeTableRouteAddressPrefix": {
              "type": "string",
              "defaultValue": "0.0.0.0/0"
            },
            "routeTableRouteNextHopIpAddress": {
              "type": "string",
              "defaultValue": "[parameters('firewallPrivateIPAddress')]"
            },
            "routeTableRouteNextHopType": {
              "type": "string",
              "defaultValue": "VirtualAppliance"
            }
          },
          "functions": [],
          "resources": [
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-06-01",
              "name": "logStorage",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "storageAccountName": {
                    "value": "[parameters('logStorageAccountName')]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "skuName": {
                    "value": "[parameters('logStorageSkuName')]"
                  },
                  "tags": {
                    "value": "[parameters('tags')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.1008.15138",
                      "templateHash": "779275696574787628"
                    }
                  },
                  "parameters": {
                    "storageAccountName": {
                      "type": "string"
                    },
                    "location": {
                      "type": "string"
                    },
                    "skuName": {
                      "type": "string"
                    },
                    "tags": {
                      "type": "object",
                      "defaultValue": {}
                    }
                  },
                  "functions": [],
                  "resources": [
                    {
                      "type": "Microsoft.Storage/storageAccounts",
                      "apiVersion": "2019-06-01",
                      "name": "[parameters('storageAccountName')]",
                      "location": "[parameters('location')]",
                      "kind": "Storage",
                      "sku": {
                        "name": "[parameters('skuName')]"
                      },
                      "tags": "[parameters('tags')]"
                    }
                  ],
                  "outputs": {
                    "id": {
                      "type": "string",
                      "value": "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName'))]"
                    }
                  }
                }
              }
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-06-01",
              "name": "networkSecurityGroup",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "name": {
                    "value": "[parameters('networkSecurityGroupName')]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "tags": {
                    "value": "[parameters('tags')]"
                  },
                  "securityRules": {
                    "value": "[parameters('networkSecurityGroupRules')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.1008.15138",
                      "templateHash": "17850607432557549000"
                    }
                  },
                  "parameters": {
                    "name": {
                      "type": "string"
                    },
                    "location": {
                      "type": "string"
                    },
                    "tags": {
                      "type": "object",
                      "defaultValue": {}
                    },
                    "securityRules": {
                      "type": "array"
                    }
                  },
                  "functions": [],
                  "resources": [
                    {
                      "type": "Microsoft.Network/networkSecurityGroups",
                      "apiVersion": "2018-11-01",
                      "name": "[parameters('name')]",
                      "location": "[parameters('location')]",
                      "tags": "[parameters('tags')]",
                      "properties": {
                        "securityRules": "[parameters('securityRules')]"
                      }
                    }
                  ],
                  "outputs": {
                    "id": {
                      "type": "string",
                      "value": "[resourceId('Microsoft.Network/networkSecurityGroups', parameters('name'))]"
                    },
                    "name": {
                      "type": "string",
                      "value": "[parameters('name')]"
                    }
                  }
                }
              }
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-06-01",
              "name": "routeTable",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "name": {
                    "value": "[parameters('routeTableName')]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "tags": {
                    "value": "[parameters('tags')]"
                  },
                  "routeName": {
                    "value": "[parameters('routeTableRouteName')]"
                  },
                  "routeAddressPrefix": {
                    "value": "[parameters('routeTableRouteAddressPrefix')]"
                  },
                  "routeNextHopIpAddress": {
                    "value": "[parameters('routeTableRouteNextHopIpAddress')]"
                  },
                  "routeNextHopType": {
                    "value": "[parameters('routeTableRouteNextHopType')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.1008.15138",
                      "templateHash": "5972748863454844401"
                    }
                  },
                  "parameters": {
                    "name": {
                      "type": "string"
                    },
                    "location": {
                      "type": "string"
                    },
                    "tags": {
                      "type": "object",
                      "defaultValue": {}
                    },
                    "routeName": {
                      "type": "string"
                    },
                    "routeAddressPrefix": {
                      "type": "string"
                    },
                    "routeNextHopIpAddress": {
                      "type": "string"
                    },
                    "routeNextHopType": {
                      "type": "string"
                    }
                  },
                  "functions": [],
                  "resources": [
                    {
                      "type": "Microsoft.Network/routeTables",
                      "apiVersion": "2018-11-01",
                      "name": "[parameters('name')]",
                      "location": "[parameters('location')]",
                      "tags": "[parameters('tags')]",
                      "properties": {
                        "routes": [
                          {
                            "name": "[parameters('routeName')]",
                            "properties": {
                              "addressPrefix": "[parameters('routeAddressPrefix')]",
                              "nextHopIpAddress": "[parameters('routeNextHopIpAddress')]",
                              "nextHopType": "[parameters('routeNextHopType')]"
                            }
                          }
                        ]
                      }
                    }
                  ],
                  "outputs": {
                    "id": {
                      "type": "string",
                      "value": "[resourceId('Microsoft.Network/routeTables', parameters('name'))]"
                    },
                    "name": {
                      "type": "string",
                      "value": "[parameters('name')]"
                    }
                  }
                }
              }
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-06-01",
              "name": "virtualNetwork",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "name": {
                    "value": "[parameters('virtualNetworkName')]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "tags": {
                    "value": "[parameters('tags')]"
                  },
                  "addressPrefix": {
                    "value": "[parameters('virtualNetworkAddressPrefix')]"
                  },
                  "subnets": {
                    "value": [
                      {
                        "name": "[parameters('subnetName')]",
                        "properties": {
                          "addressPrefix": "[parameters('subnetAddressPrefix')]",
                          "networkSecurityGroup": {
                            "id": "[reference(resourceId('Microsoft.Resources/deployments', 'networkSecurityGroup'), '2020-06-01').outputs.id.value]"
                          },
                          "routeTable": {
                            "id": "[reference(resourceId('Microsoft.Resources/deployments', 'routeTable'), '2020-06-01').outputs.id.value]"
                          }
                        }
                      }
                    ]
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.1008.15138",
                      "templateHash": "4423030218172085734"
                    }
                  },
                  "parameters": {
                    "name": {
                      "type": "string"
                    },
                    "location": {
                      "type": "string"
                    },
                    "tags": {
                      "type": "object",
                      "defaultValue": {}
                    },
                    "addressPrefix": {
                      "type": "string"
                    },
                    "subnets": {
                      "type": "array"
                    }
                  },
                  "functions": [],
                  "resources": [
                    {
                      "type": "Microsoft.Network/virtualNetworks",
                      "apiVersion": "2018-11-01",
                      "name": "[parameters('name')]",
                      "location": "[parameters('location')]",
                      "tags": "[parameters('tags')]",
                      "properties": {
                        "addressSpace": {
                          "addressPrefixes": [
                            "[parameters('addressPrefix')]"
                          ]
                        },
                        "subnets": "[parameters('subnets')]"
                      }
                    }
                  ],
                  "outputs": {
                    "name": {
                      "type": "string",
                      "value": "[parameters('name')]"
                    },
                    "id": {
                      "type": "string",
                      "value": "[resourceId('Microsoft.Network/virtualNetworks', parameters('name'))]"
                    },
                    "subnets": {
                      "type": "array",
                      "value": "[reference(resourceId('Microsoft.Network/virtualNetworks', parameters('name'))).subnets]"
                    }
                  }
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', 'networkSecurityGroup')]",
                "[resourceId('Microsoft.Resources/deployments', 'routeTable')]"
              ]
            }
          ],
          "outputs": {
            "virtualNetworkName": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Resources/deployments', 'virtualNetwork'), '2020-06-01').outputs.name.value]"
            },
            "virtualNetworkResourceId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Resources/deployments', 'virtualNetwork'), '2020-06-01').outputs.id.value]"
            },
            "subnetName": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Resources/deployments', 'virtualNetwork'), '2020-06-01').outputs.subnets.value[0].name]"
            },
            "subnetAddressPrefix": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Resources/deployments', 'virtualNetwork'), '2020-06-01').outputs.subnets.value[0].properties.addressPrefix]"
            },
            "subnetResourceId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Resources/deployments', 'virtualNetwork'), '2020-06-01').outputs.subnets.value[0].id]"
            },
            "networkSecurityGroupName": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Resources/deployments', 'networkSecurityGroup'), '2020-06-01').outputs.name.value]"
            },
            "networkSecurityGroupResourceId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Resources/deployments', 'networkSecurityGroup'), '2020-06-01').outputs.id.value]"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-06-01",
      "name": "[format('deploy-sharedServices-spoke-{0}', parameters('nowUtc'))]",
      "resourceGroup": "[parameters('sharedServicesResourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('sharedServicesLocation')]"
          },
          "tags": {
            "value": "[parameters('tags')]"
          },
          "logStorageAccountName": {
            "value": "[parameters('sharedServicesLogStorageAccountName')]"
          },
          "logStorageSkuName": {
            "value": "[parameters('sharedServicesLogStorageSkuName')]"
          },
          "firewallPrivateIPAddress": {
            "value": "10.0.100.4"
          },
          "virtualNetworkName": {
            "value": "[parameters('sharedServicesVirtualNetworkName')]"
          },
          "virtualNetworkAddressPrefix": {
            "value": "[parameters('sharedServicesVirtualNetworkAddressPrefix')]"
          },
          "networkSecurityGroupName": {
            "value": "[parameters('sharedServicesNetworkSecurityGroupName')]"
          },
          "networkSecurityGroupRules": {
            "value": "[parameters('sharedServicesNetworkSecurityGroupRules')]"
          },
          "subnetName": {
            "value": "[parameters('sharedServicesSubnetName')]"
          },
          "subnetAddressPrefix": {
            "value": "[parameters('sharedServicesSubnetAddressPrefix')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.4.1008.15138",
              "templateHash": "3095237861841650734"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]"
            },
            "tags": {
              "type": "object",
              "defaultValue": {}
            },
            "logStorageAccountName": {
              "type": "string"
            },
            "logStorageSkuName": {
              "type": "string"
            },
            "firewallPrivateIPAddress": {
              "type": "string"
            },
            "virtualNetworkName": {
              "type": "string"
            },
            "virtualNetworkAddressPrefix": {
              "type": "string"
            },
            "networkSecurityGroupName": {
              "type": "string"
            },
            "networkSecurityGroupRules": {
              "type": "array"
            },
            "subnetName": {
              "type": "string"
            },
            "subnetAddressPrefix": {
              "type": "string"
            },
            "routeTableName": {
              "type": "string",
              "defaultValue": "[format('{0}-routetable', parameters('subnetName'))]"
            },
            "routeTableRouteName": {
              "type": "string",
              "defaultValue": "default_route"
            },
            "routeTableRouteAddressPrefix": {
              "type": "string",
              "defaultValue": "0.0.0.0/0"
            },
            "routeTableRouteNextHopIpAddress": {
              "type": "string",
              "defaultValue": "[parameters('firewallPrivateIPAddress')]"
            },
            "routeTableRouteNextHopType": {
              "type": "string",
              "defaultValue": "VirtualAppliance"
            }
          },
          "functions": [],
          "resources": [
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-06-01",
              "name": "logStorage",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "storageAccountName": {
                    "value": "[parameters('logStorageAccountName')]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "skuName": {
                    "value": "[parameters('logStorageSkuName')]"
                  },
                  "tags": {
                    "value": "[parameters('tags')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.1008.15138",
                      "templateHash": "779275696574787628"
                    }
                  },
                  "parameters": {
                    "storageAccountName": {
                      "type": "string"
                    },
                    "location": {
                      "type": "string"
                    },
                    "skuName": {
                      "type": "string"
                    },
                    "tags": {
                      "type": "object",
                      "defaultValue": {}
                    }
                  },
                  "functions": [],
                  "resources": [
                    {
                      "type": "Microsoft.Storage/storageAccounts",
                      "apiVersion": "2019-06-01",
                      "name": "[parameters('storageAccountName')]",
                      "location": "[parameters('location')]",
                      "kind": "Storage",
                      "sku": {
                        "name": "[parameters('skuName')]"
                      },
                      "tags": "[parameters('tags')]"
                    }
                  ],
                  "outputs": {
                    "id": {
                      "type": "string",
                      "value": "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName'))]"
                    }
                  }
                }
              }
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-06-01",
              "name": "networkSecurityGroup",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "name": {
                    "value": "[parameters('networkSecurityGroupName')]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "tags": {
                    "value": "[parameters('tags')]"
                  },
                  "securityRules": {
                    "value": "[parameters('networkSecurityGroupRules')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.1008.15138",
                      "templateHash": "17850607432557549000"
                    }
                  },
                  "parameters": {
                    "name": {
                      "type": "string"
                    },
                    "location": {
                      "type": "string"
                    },
                    "tags": {
                      "type": "object",
                      "defaultValue": {}
                    },
                    "securityRules": {
                      "type": "array"
                    }
                  },
                  "functions": [],
                  "resources": [
                    {
                      "type": "Microsoft.Network/networkSecurityGroups",
                      "apiVersion": "2018-11-01",
                      "name": "[parameters('name')]",
                      "location": "[parameters('location')]",
                      "tags": "[parameters('tags')]",
                      "properties": {
                        "securityRules": "[parameters('securityRules')]"
                      }
                    }
                  ],
                  "outputs": {
                    "id": {
                      "type": "string",
                      "value": "[resourceId('Microsoft.Network/networkSecurityGroups', parameters('name'))]"
                    },
                    "name": {
                      "type": "string",
                      "value": "[parameters('name')]"
                    }
                  }
                }
              }
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-06-01",
              "name": "routeTable",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "name": {
                    "value": "[parameters('routeTableName')]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "tags": {
                    "value": "[parameters('tags')]"
                  },
                  "routeName": {
                    "value": "[parameters('routeTableRouteName')]"
                  },
                  "routeAddressPrefix": {
                    "value": "[parameters('routeTableRouteAddressPrefix')]"
                  },
                  "routeNextHopIpAddress": {
                    "value": "[parameters('routeTableRouteNextHopIpAddress')]"
                  },
                  "routeNextHopType": {
                    "value": "[parameters('routeTableRouteNextHopType')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.1008.15138",
                      "templateHash": "5972748863454844401"
                    }
                  },
                  "parameters": {
                    "name": {
                      "type": "string"
                    },
                    "location": {
                      "type": "string"
                    },
                    "tags": {
                      "type": "object",
                      "defaultValue": {}
                    },
                    "routeName": {
                      "type": "string"
                    },
                    "routeAddressPrefix": {
                      "type": "string"
                    },
                    "routeNextHopIpAddress": {
                      "type": "string"
                    },
                    "routeNextHopType": {
                      "type": "string"
                    }
                  },
                  "functions": [],
                  "resources": [
                    {
                      "type": "Microsoft.Network/routeTables",
                      "apiVersion": "2018-11-01",
                      "name": "[parameters('name')]",
                      "location": "[parameters('location')]",
                      "tags": "[parameters('tags')]",
                      "properties": {
                        "routes": [
                          {
                            "name": "[parameters('routeName')]",
                            "properties": {
                              "addressPrefix": "[parameters('routeAddressPrefix')]",
                              "nextHopIpAddress": "[parameters('routeNextHopIpAddress')]",
                              "nextHopType": "[parameters('routeNextHopType')]"
                            }
                          }
                        ]
                      }
                    }
                  ],
                  "outputs": {
                    "id": {
                      "type": "string",
                      "value": "[resourceId('Microsoft.Network/routeTables', parameters('name'))]"
                    },
                    "name": {
                      "type": "string",
                      "value": "[parameters('name')]"
                    }
                  }
                }
              }
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-06-01",
              "name": "virtualNetwork",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "name": {
                    "value": "[parameters('virtualNetworkName')]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "tags": {
                    "value": "[parameters('tags')]"
                  },
                  "addressPrefix": {
                    "value": "[parameters('virtualNetworkAddressPrefix')]"
                  },
                  "subnets": {
                    "value": [
                      {
                        "name": "[parameters('subnetName')]",
                        "properties": {
                          "addressPrefix": "[parameters('subnetAddressPrefix')]",
                          "networkSecurityGroup": {
                            "id": "[reference(resourceId('Microsoft.Resources/deployments', 'networkSecurityGroup'), '2020-06-01').outputs.id.value]"
                          },
                          "routeTable": {
                            "id": "[reference(resourceId('Microsoft.Resources/deployments', 'routeTable'), '2020-06-01').outputs.id.value]"
                          }
                        }
                      }
                    ]
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.1008.15138",
                      "templateHash": "4423030218172085734"
                    }
                  },
                  "parameters": {
                    "name": {
                      "type": "string"
                    },
                    "location": {
                      "type": "string"
                    },
                    "tags": {
                      "type": "object",
                      "defaultValue": {}
                    },
                    "addressPrefix": {
                      "type": "string"
                    },
                    "subnets": {
                      "type": "array"
                    }
                  },
                  "functions": [],
                  "resources": [
                    {
                      "type": "Microsoft.Network/virtualNetworks",
                      "apiVersion": "2018-11-01",
                      "name": "[parameters('name')]",
                      "location": "[parameters('location')]",
                      "tags": "[parameters('tags')]",
                      "properties": {
                        "addressSpace": {
                          "addressPrefixes": [
                            "[parameters('addressPrefix')]"
                          ]
                        },
                        "subnets": "[parameters('subnets')]"
                      }
                    }
                  ],
                  "outputs": {
                    "name": {
                      "type": "string",
                      "value": "[parameters('name')]"
                    },
                    "id": {
                      "type": "string",
                      "value": "[resourceId('Microsoft.Network/virtualNetworks', parameters('name'))]"
                    },
                    "subnets": {
                      "type": "array",
                      "value": "[reference(resourceId('Microsoft.Network/virtualNetworks', parameters('name'))).subnets]"
                    }
                  }
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', 'networkSecurityGroup')]",
                "[resourceId('Microsoft.Resources/deployments', 'routeTable')]"
              ]
            }
          ],
          "outputs": {
            "virtualNetworkName": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Resources/deployments', 'virtualNetwork'), '2020-06-01').outputs.name.value]"
            },
            "virtualNetworkResourceId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Resources/deployments', 'virtualNetwork'), '2020-06-01').outputs.id.value]"
            },
            "subnetName": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Resources/deployments', 'virtualNetwork'), '2020-06-01').outputs.subnets.value[0].name]"
            },
            "subnetAddressPrefix": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Resources/deployments', 'virtualNetwork'), '2020-06-01').outputs.subnets.value[0].properties.addressPrefix]"
            },
            "subnetResourceId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Resources/deployments', 'virtualNetwork'), '2020-06-01').outputs.subnets.value[0].id]"
            },
            "networkSecurityGroupName": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Resources/deployments', 'networkSecurityGroup'), '2020-06-01').outputs.name.value]"
            },
            "networkSecurityGroupResourceId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Resources/deployments', 'networkSecurityGroup'), '2020-06-01').outputs.id.value]"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-06-01",
      "name": "[format('deploy-hub-peerings-{0}', parameters('nowUtc'))]",
      "location": "[deployment().location]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "hubResourceGroupName": {
            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-hub-rg-{0}', parameters('nowUtc'))), '2020-06-01').outputs.name.value]"
          },
          "hubVirtualNetworkName": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('hubResourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-hub-{0}', parameters('nowUtc'))), '2020-06-01').outputs.virtualNetworkName.value]"
          },
          "identityVirtualNetworkName": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('identityResourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-identity-spoke-{0}', parameters('nowUtc'))), '2020-06-01').outputs.virtualNetworkName.value]"
          },
          "operationsVirtualNetworkName": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('operationsResourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-operations-spoke-{0}', parameters('nowUtc'))), '2020-06-01').outputs.virtualNetworkName.value]"
          },
          "sharedServicesVirtualNetworkName": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('sharedServicesResourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-sharedServices-spoke-{0}', parameters('nowUtc'))), '2020-06-01').outputs.virtualNetworkName.value]"
          },
          "identityVirtualNetworkResourceId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('identityResourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-identity-spoke-{0}', parameters('nowUtc'))), '2020-06-01').outputs.virtualNetworkResourceId.value]"
          },
          "operationsVirtualNetworkResourceId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('operationsResourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-operations-spoke-{0}', parameters('nowUtc'))), '2020-06-01').outputs.virtualNetworkResourceId.value]"
          },
          "sharedServicesVirtualNetworkResourceId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('sharedServicesResourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-sharedServices-spoke-{0}', parameters('nowUtc'))), '2020-06-01').outputs.virtualNetworkResourceId.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.4.1008.15138",
              "templateHash": "6275358176261131826"
            }
          },
          "parameters": {
            "hubResourceGroupName": {
              "type": "string"
            },
            "hubVirtualNetworkName": {
              "type": "string"
            },
            "identityVirtualNetworkName": {
              "type": "string"
            },
            "identityVirtualNetworkResourceId": {
              "type": "string"
            },
            "operationsVirtualNetworkName": {
              "type": "string"
            },
            "operationsVirtualNetworkResourceId": {
              "type": "string"
            },
            "sharedServicesVirtualNetworkName": {
              "type": "string"
            },
            "sharedServicesVirtualNetworkResourceId": {
              "type": "string"
            }
          },
          "functions": [],
          "resources": [
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-06-01",
              "name": "hubToIdentityVirtualNetworkPeering",
              "resourceGroup": "[parameters('hubResourceGroupName')]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "name": {
                    "value": "[format('{0}/to-{1}', parameters('hubVirtualNetworkName'), parameters('identityVirtualNetworkName'))]"
                  },
                  "remoteVirtualNetworkResourceId": {
                    "value": "[parameters('identityVirtualNetworkResourceId')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.1008.15138",
                      "templateHash": "10308230389657822192"
                    }
                  },
                  "parameters": {
                    "name": {
                      "type": "string"
                    },
                    "remoteVirtualNetworkResourceId": {
                      "type": "string"
                    }
                  },
                  "functions": [],
                  "resources": [
                    {
                      "type": "Microsoft.Network/virtualNetworks/virtualNetworkPeerings",
                      "apiVersion": "2018-11-01",
                      "name": "[parameters('name')]",
                      "properties": {
                        "remoteVirtualNetwork": {
                          "id": "[parameters('remoteVirtualNetworkResourceId')]"
                        }
                      }
                    }
                  ]
                }
              }
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-06-01",
              "name": "hubToOperationsVirtualNetworkPeering",
              "resourceGroup": "[parameters('hubResourceGroupName')]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "name": {
                    "value": "[format('{0}/to-{1}', parameters('hubVirtualNetworkName'), parameters('operationsVirtualNetworkName'))]"
                  },
                  "remoteVirtualNetworkResourceId": {
                    "value": "[parameters('operationsVirtualNetworkResourceId')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.1008.15138",
                      "templateHash": "10308230389657822192"
                    }
                  },
                  "parameters": {
                    "name": {
                      "type": "string"
                    },
                    "remoteVirtualNetworkResourceId": {
                      "type": "string"
                    }
                  },
                  "functions": [],
                  "resources": [
                    {
                      "type": "Microsoft.Network/virtualNetworks/virtualNetworkPeerings",
                      "apiVersion": "2018-11-01",
                      "name": "[parameters('name')]",
                      "properties": {
                        "remoteVirtualNetwork": {
                          "id": "[parameters('remoteVirtualNetworkResourceId')]"
                        }
                      }
                    }
                  ]
                }
              }
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-06-01",
              "name": "hubToSharedServicesVirtualNetworkPeering",
              "resourceGroup": "[parameters('hubResourceGroupName')]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "name": {
                    "value": "[format('{0}/to-{1}', parameters('hubVirtualNetworkName'), parameters('sharedServicesVirtualNetworkName'))]"
                  },
                  "remoteVirtualNetworkResourceId": {
                    "value": "[parameters('sharedServicesVirtualNetworkResourceId')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.1008.15138",
                      "templateHash": "10308230389657822192"
                    }
                  },
                  "parameters": {
                    "name": {
                      "type": "string"
                    },
                    "remoteVirtualNetworkResourceId": {
                      "type": "string"
                    }
                  },
                  "functions": [],
                  "resources": [
                    {
                      "type": "Microsoft.Network/virtualNetworks/virtualNetworkPeerings",
                      "apiVersion": "2018-11-01",
                      "name": "[parameters('name')]",
                      "properties": {
                        "remoteVirtualNetwork": {
                          "id": "[parameters('remoteVirtualNetworkResourceId')]"
                        }
                      }
                    }
                  ]
                }
              }
            }
          ]
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('hubResourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-hub-{0}', parameters('nowUtc')))]",
        "[subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-hub-rg-{0}', parameters('nowUtc')))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('identityResourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-identity-spoke-{0}', parameters('nowUtc')))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('operationsResourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-operations-spoke-{0}', parameters('nowUtc')))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('sharedServicesResourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-sharedServices-spoke-{0}', parameters('nowUtc')))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-06-01",
      "name": "[format('deploy-identity-peerings-{0}', parameters('nowUtc'))]",
      "location": "[deployment().location]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "spokeResourceGroupName": {
            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-identity-rg-{0}', parameters('nowUtc'))), '2020-06-01').outputs.name.value]"
          },
          "spokeVirtualNetworkName": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('identityResourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-identity-spoke-{0}', parameters('nowUtc'))), '2020-06-01').outputs.virtualNetworkName.value]"
          },
          "hubVirtualNetworkName": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('hubResourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-hub-{0}', parameters('nowUtc'))), '2020-06-01').outputs.virtualNetworkName.value]"
          },
          "hubVirtualNetworkResourceId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('hubResourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-hub-{0}', parameters('nowUtc'))), '2020-06-01').outputs.virtualNetworkResourceId.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.4.1008.15138",
              "templateHash": "1936550324306541626"
            }
          },
          "parameters": {
            "spokeResourceGroupName": {
              "type": "string"
            },
            "spokeVirtualNetworkName": {
              "type": "string"
            },
            "hubVirtualNetworkName": {
              "type": "string"
            },
            "hubVirtualNetworkResourceId": {
              "type": "string"
            }
          },
          "functions": [],
          "resources": [
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-06-01",
              "name": "spokeNetworkPeering",
              "resourceGroup": "[parameters('spokeResourceGroupName')]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "name": {
                    "value": "[format('{0}/to-{1}', parameters('spokeVirtualNetworkName'), parameters('hubVirtualNetworkName'))]"
                  },
                  "remoteVirtualNetworkResourceId": {
                    "value": "[parameters('hubVirtualNetworkResourceId')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.1008.15138",
                      "templateHash": "10308230389657822192"
                    }
                  },
                  "parameters": {
                    "name": {
                      "type": "string"
                    },
                    "remoteVirtualNetworkResourceId": {
                      "type": "string"
                    }
                  },
                  "functions": [],
                  "resources": [
                    {
                      "type": "Microsoft.Network/virtualNetworks/virtualNetworkPeerings",
                      "apiVersion": "2018-11-01",
                      "name": "[parameters('name')]",
                      "properties": {
                        "remoteVirtualNetwork": {
                          "id": "[parameters('remoteVirtualNetworkResourceId')]"
                        }
                      }
                    }
                  ]
                }
              }
            }
          ]
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('hubResourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-hub-{0}', parameters('nowUtc')))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('identityResourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-identity-spoke-{0}', parameters('nowUtc')))]",
        "[subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-identity-rg-{0}', parameters('nowUtc')))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-06-01",
      "name": "[format('deploy-operations-peerings-{0}', parameters('nowUtc'))]",
      "location": "[deployment().location]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "spokeResourceGroupName": {
            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-operations-rg-{0}', parameters('nowUtc'))), '2020-06-01').outputs.name.value]"
          },
          "spokeVirtualNetworkName": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('operationsResourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-operations-spoke-{0}', parameters('nowUtc'))), '2020-06-01').outputs.virtualNetworkName.value]"
          },
          "hubVirtualNetworkName": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('hubResourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-hub-{0}', parameters('nowUtc'))), '2020-06-01').outputs.virtualNetworkName.value]"
          },
          "hubVirtualNetworkResourceId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('hubResourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-hub-{0}', parameters('nowUtc'))), '2020-06-01').outputs.virtualNetworkResourceId.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.4.1008.15138",
              "templateHash": "1936550324306541626"
            }
          },
          "parameters": {
            "spokeResourceGroupName": {
              "type": "string"
            },
            "spokeVirtualNetworkName": {
              "type": "string"
            },
            "hubVirtualNetworkName": {
              "type": "string"
            },
            "hubVirtualNetworkResourceId": {
              "type": "string"
            }
          },
          "functions": [],
          "resources": [
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-06-01",
              "name": "spokeNetworkPeering",
              "resourceGroup": "[parameters('spokeResourceGroupName')]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "name": {
                    "value": "[format('{0}/to-{1}', parameters('spokeVirtualNetworkName'), parameters('hubVirtualNetworkName'))]"
                  },
                  "remoteVirtualNetworkResourceId": {
                    "value": "[parameters('hubVirtualNetworkResourceId')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.1008.15138",
                      "templateHash": "10308230389657822192"
                    }
                  },
                  "parameters": {
                    "name": {
                      "type": "string"
                    },
                    "remoteVirtualNetworkResourceId": {
                      "type": "string"
                    }
                  },
                  "functions": [],
                  "resources": [
                    {
                      "type": "Microsoft.Network/virtualNetworks/virtualNetworkPeerings",
                      "apiVersion": "2018-11-01",
                      "name": "[parameters('name')]",
                      "properties": {
                        "remoteVirtualNetwork": {
                          "id": "[parameters('remoteVirtualNetworkResourceId')]"
                        }
                      }
                    }
                  ]
                }
              }
            }
          ]
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('hubResourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-hub-{0}', parameters('nowUtc')))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('operationsResourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-operations-spoke-{0}', parameters('nowUtc')))]",
        "[subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-operations-rg-{0}', parameters('nowUtc')))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-06-01",
      "name": "[format('deploy-sharedServices-peerings-{0}', parameters('nowUtc'))]",
      "location": "[deployment().location]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "spokeResourceGroupName": {
            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-sharedServices-rg-{0}', parameters('nowUtc'))), '2020-06-01').outputs.name.value]"
          },
          "spokeVirtualNetworkName": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('sharedServicesResourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-sharedServices-spoke-{0}', parameters('nowUtc'))), '2020-06-01').outputs.virtualNetworkName.value]"
          },
          "hubVirtualNetworkName": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('hubResourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-hub-{0}', parameters('nowUtc'))), '2020-06-01').outputs.virtualNetworkName.value]"
          },
          "hubVirtualNetworkResourceId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('hubResourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-hub-{0}', parameters('nowUtc'))), '2020-06-01').outputs.virtualNetworkResourceId.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.4.1008.15138",
              "templateHash": "1936550324306541626"
            }
          },
          "parameters": {
            "spokeResourceGroupName": {
              "type": "string"
            },
            "spokeVirtualNetworkName": {
              "type": "string"
            },
            "hubVirtualNetworkName": {
              "type": "string"
            },
            "hubVirtualNetworkResourceId": {
              "type": "string"
            }
          },
          "functions": [],
          "resources": [
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-06-01",
              "name": "spokeNetworkPeering",
              "resourceGroup": "[parameters('spokeResourceGroupName')]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "name": {
                    "value": "[format('{0}/to-{1}', parameters('spokeVirtualNetworkName'), parameters('hubVirtualNetworkName'))]"
                  },
                  "remoteVirtualNetworkResourceId": {
                    "value": "[parameters('hubVirtualNetworkResourceId')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.1008.15138",
                      "templateHash": "10308230389657822192"
                    }
                  },
                  "parameters": {
                    "name": {
                      "type": "string"
                    },
                    "remoteVirtualNetworkResourceId": {
                      "type": "string"
                    }
                  },
                  "functions": [],
                  "resources": [
                    {
                      "type": "Microsoft.Network/virtualNetworks/virtualNetworkPeerings",
                      "apiVersion": "2018-11-01",
                      "name": "[parameters('name')]",
                      "properties": {
                        "remoteVirtualNetwork": {
                          "id": "[parameters('remoteVirtualNetworkResourceId')]"
                        }
                      }
                    }
                  ]
                }
              }
            }
          ]
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('hubResourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-hub-{0}', parameters('nowUtc')))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('sharedServicesResourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-sharedServices-spoke-{0}', parameters('nowUtc')))]",
        "[subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-sharedServices-rg-{0}', parameters('nowUtc')))]"
      ]
    },
    {
      "condition": "[parameters('deployRemoteAccess')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-06-01",
      "name": "[format('deploy-remote-access-{0}', parameters('nowUtc'))]",
      "resourceGroup": "[parameters('hubResourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('hubLocation')]"
          },
          "hubVirtualNetworkName": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('hubResourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-hub-{0}', parameters('nowUtc'))), '2020-06-01').outputs.virtualNetworkName.value]"
          },
          "hubSubnetResourceId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('hubResourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-hub-{0}', parameters('nowUtc'))), '2020-06-01').outputs.subnetResourceId.value]"
          },
          "hubNetworkSecurityGroupResourceId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('hubResourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-hub-{0}', parameters('nowUtc'))), '2020-06-01').outputs.networkSecurityGroupResourceId.value]"
          },
          "bastionHostName": {
            "value": "[parameters('bastionHostName')]"
          },
          "bastionHostSubnetAddressPrefix": {
            "value": "[parameters('bastionHostSubnetAddressPrefix')]"
          },
          "bastionHostPublicIPAddressName": {
            "value": "[parameters('bastionHostPublicIPAddressName')]"
          },
          "bastionHostPublicIPAddressSkuName": {
            "value": "[parameters('bastionHostPublicIPAddressSkuName')]"
          },
          "bastionHostPublicIPAddressAllocationMethod": {
            "value": "[parameters('bastionHostPublicIPAddressAllocationMethod')]"
          },
          "bastionHostPublicIPAddressAvailabilityZones": {
            "value": "[parameters('bastionHostPublicIPAddressAvailabilityZones')]"
          },
          "bastionHostIPConfigurationName": {
            "value": "[parameters('bastionHostIPConfigurationName')]"
          },
          "linuxNetworkInterfaceName": {
            "value": "[parameters('linuxNetworkInterfaceName')]"
          },
          "linuxNetworkInterfaceIpConfigurationName": {
            "value": "[parameters('linuxNetworkInterfaceIpConfigurationName')]"
          },
          "linuxNetworkInterfacePrivateIPAddressAllocationMethod": {
            "value": "[parameters('linuxNetworkInterfacePrivateIPAddressAllocationMethod')]"
          },
          "linuxVmName": {
            "value": "[parameters('linuxVmName')]"
          },
          "linuxVmSize": {
            "value": "[parameters('linuxVmSize')]"
          },
          "linuxVmOsDiskCreateOption": {
            "value": "[parameters('linuxVmOsDiskCreateOption')]"
          },
          "linuxVmOsDiskType": {
            "value": "[parameters('linuxVmOsDiskType')]"
          },
          "linuxVmImagePublisher": {
            "value": "[parameters('linuxVmImagePublisher')]"
          },
          "linuxVmImageOffer": {
            "value": "[parameters('linuxVmImageOffer')]"
          },
          "linuxVmImageSku": {
            "value": "[parameters('linuxVmImageSku')]"
          },
          "linuxVmImageVersion": {
            "value": "[parameters('linuxVmImageVersion')]"
          },
          "linuxVmAdminUsername": {
            "value": "[parameters('linuxVmAdminUsername')]"
          },
          "linuxVmAuthenticationType": {
            "value": "[parameters('linuxVmAuthenticationType')]"
          },
          "linuxVmAdminPasswordOrKey": {
            "value": "[parameters('linuxVmAdminPasswordOrKey')]"
          },
          "windowsNetworkInterfaceName": {
            "value": "[parameters('windowsNetworkInterfaceName')]"
          },
          "windowsNetworkInterfaceIpConfigurationName": {
            "value": "[parameters('windowsNetworkInterfaceIpConfigurationName')]"
          },
          "windowsNetworkInterfacePrivateIPAddressAllocationMethod": {
            "value": "[parameters('windowsNetworkInterfacePrivateIPAddressAllocationMethod')]"
          },
          "windowsVmName": {
            "value": "[parameters('windowsVmName')]"
          },
          "windowsVmSize": {
            "value": "[parameters('windowsVmSize')]"
          },
          "windowsVmAdminUsername": {
            "value": "[parameters('windowsVmAdminUsername')]"
          },
          "windowsVmAdminPassword": {
            "value": "[parameters('windowsVmAdminPassword')]"
          },
          "windowsVmPublisher": {
            "value": "[parameters('windowsVmPublisher')]"
          },
          "windowsVmOffer": {
            "value": "[parameters('windowsVmOffer')]"
          },
          "windowsVmSku": {
            "value": "[parameters('windowsVmSku')]"
          },
          "windowsVmVersion": {
            "value": "[parameters('windowsVmVersion')]"
          },
          "windowsVmCreateOption": {
            "value": "[parameters('windowsVmCreateOption')]"
          },
          "windowsVmStorageAccountType": {
            "value": "[parameters('windowsVmStorageAccountType')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.4.1008.15138",
              "templateHash": "14488114785265340288"
            }
          },
          "parameters": {
            "location": {
              "type": "string"
            },
            "tags": {
              "type": "object",
              "defaultValue": {}
            },
            "hubVirtualNetworkName": {
              "type": "string"
            },
            "hubSubnetResourceId": {
              "type": "string"
            },
            "hubNetworkSecurityGroupResourceId": {
              "type": "string"
            },
            "bastionHostName": {
              "type": "string"
            },
            "bastionHostSubnetAddressPrefix": {
              "type": "string"
            },
            "bastionHostPublicIPAddressName": {
              "type": "string"
            },
            "bastionHostPublicIPAddressSkuName": {
              "type": "string"
            },
            "bastionHostPublicIPAddressAllocationMethod": {
              "type": "string"
            },
            "bastionHostPublicIPAddressAvailabilityZones": {
              "type": "array"
            },
            "bastionHostIPConfigurationName": {
              "type": "string"
            },
            "linuxNetworkInterfaceName": {
              "type": "string"
            },
            "linuxNetworkInterfaceIpConfigurationName": {
              "type": "string"
            },
            "linuxNetworkInterfacePrivateIPAddressAllocationMethod": {
              "type": "string"
            },
            "linuxVmName": {
              "type": "string"
            },
            "linuxVmSize": {
              "type": "string"
            },
            "linuxVmOsDiskCreateOption": {
              "type": "string"
            },
            "linuxVmOsDiskType": {
              "type": "string"
            },
            "linuxVmImagePublisher": {
              "type": "string"
            },
            "linuxVmImageOffer": {
              "type": "string"
            },
            "linuxVmImageSku": {
              "type": "string"
            },
            "linuxVmImageVersion": {
              "type": "string"
            },
            "linuxVmAdminUsername": {
              "type": "string"
            },
            "linuxVmAuthenticationType": {
              "type": "string",
              "allowedValues": [
                "sshPublicKey",
                "password"
              ]
            },
            "linuxVmAdminPasswordOrKey": {
              "type": "secureString",
              "minLength": 14
            },
            "windowsNetworkInterfaceName": {
              "type": "string"
            },
            "windowsNetworkInterfaceIpConfigurationName": {
              "type": "string"
            },
            "windowsNetworkInterfacePrivateIPAddressAllocationMethod": {
              "type": "string"
            },
            "windowsVmName": {
              "type": "string"
            },
            "windowsVmSize": {
              "type": "string"
            },
            "windowsVmAdminUsername": {
              "type": "string"
            },
            "windowsVmAdminPassword": {
              "type": "secureString",
              "minLength": 14
            },
            "windowsVmPublisher": {
              "type": "string"
            },
            "windowsVmOffer": {
              "type": "string"
            },
            "windowsVmSku": {
              "type": "string"
            },
            "windowsVmVersion": {
              "type": "string"
            },
            "windowsVmCreateOption": {
              "type": "string"
            },
            "windowsVmStorageAccountType": {
              "type": "string"
            }
          },
          "functions": [],
          "resources": [
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-06-01",
              "name": "remoteAccess-bastionHost",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "name": {
                    "value": "[parameters('bastionHostName')]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "tags": {
                    "value": "[parameters('tags')]"
                  },
                  "virtualNetworkName": {
                    "value": "[parameters('hubVirtualNetworkName')]"
                  },
                  "subnetAddressPrefix": {
                    "value": "[parameters('bastionHostSubnetAddressPrefix')]"
                  },
                  "publicIPAddressName": {
                    "value": "[parameters('bastionHostPublicIPAddressName')]"
                  },
                  "publicIPAddressSkuName": {
                    "value": "[parameters('bastionHostPublicIPAddressSkuName')]"
                  },
                  "publicIPAddressAllocationMethod": {
                    "value": "[parameters('bastionHostPublicIPAddressAllocationMethod')]"
                  },
                  "publicIPAddressAvailabilityZones": {
                    "value": "[parameters('bastionHostPublicIPAddressAvailabilityZones')]"
                  },
                  "ipConfigurationName": {
                    "value": "[parameters('bastionHostIPConfigurationName')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.1008.15138",
                      "templateHash": "1335258872501287211"
                    }
                  },
                  "parameters": {
                    "name": {
                      "type": "string"
                    },
                    "location": {
                      "type": "string"
                    },
                    "tags": {
                      "type": "object",
                      "defaultValue": {}
                    },
                    "virtualNetworkName": {
                      "type": "string"
                    },
                    "subnetAddressPrefix": {
                      "type": "string"
                    },
                    "publicIPAddressName": {
                      "type": "string"
                    },
                    "publicIPAddressSkuName": {
                      "type": "string"
                    },
                    "publicIPAddressAllocationMethod": {
                      "type": "string"
                    },
                    "publicIPAddressAvailabilityZones": {
                      "type": "array"
                    },
                    "ipConfigurationName": {
                      "type": "string"
                    }
                  },
                  "functions": [],
                  "variables": {
                    "subnetName": "AzureBastionSubnet"
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Network/publicIPAddresses",
                      "apiVersion": "2018-11-01",
                      "name": "[parameters('publicIPAddressName')]",
                      "location": "[parameters('location')]",
                      "tags": "[parameters('tags')]",
                      "sku": {
                        "name": "[parameters('publicIPAddressSkuName')]"
                      },
                      "properties": {
                        "publicIPAllocationMethod": "[parameters('publicIPAddressAllocationMethod')]"
                      },
                      "zones": "[parameters('publicIPAddressAvailabilityZones')]"
                    },
                    {
                      "type": "Microsoft.Network/virtualNetworks/subnets",
                      "apiVersion": "2018-11-01",
                      "name": "[format('{0}/{1}', parameters('virtualNetworkName'), variables('subnetName'))]",
                      "properties": {
                        "addressPrefix": "[parameters('subnetAddressPrefix')]"
                      }
                    },
                    {
                      "type": "Microsoft.Network/bastionHosts",
                      "apiVersion": "2018-11-01",
                      "name": "[parameters('name')]",
                      "location": "[parameters('location')]",
                      "tags": "[parameters('tags')]",
                      "properties": {
                        "ipConfigurations": [
                          {
                            "name": "[parameters('ipConfigurationName')]",
                            "properties": {
                              "subnet": {
                                "id": "[resourceId('Microsoft.Network/virtualNetworks/subnets', split(format('{0}/{1}', parameters('virtualNetworkName'), variables('subnetName')), '/')[0], split(format('{0}/{1}', parameters('virtualNetworkName'), variables('subnetName')), '/')[1])]"
                              },
                              "publicIPAddress": {
                                "id": "[resourceId('Microsoft.Network/publicIPAddresses', parameters('publicIPAddressName'))]"
                              }
                            }
                          }
                        ]
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Network/publicIPAddresses', parameters('publicIPAddressName'))]",
                        "[resourceId('Microsoft.Network/virtualNetworks/subnets', split(format('{0}/{1}', parameters('virtualNetworkName'), variables('subnetName')), '/')[0], split(format('{0}/{1}', parameters('virtualNetworkName'), variables('subnetName')), '/')[1])]"
                      ]
                    }
                  ]
                }
              }
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-06-01",
              "name": "remoteAccess-linuxNetworkInterface",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "name": {
                    "value": "[parameters('linuxNetworkInterfaceName')]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "tags": {
                    "value": "[parameters('tags')]"
                  },
                  "ipConfigurationName": {
                    "value": "[parameters('linuxNetworkInterfaceIpConfigurationName')]"
                  },
                  "networkSecurityGroupId": {
                    "value": "[parameters('hubNetworkSecurityGroupResourceId')]"
                  },
                  "privateIPAddressAllocationMethod": {
                    "value": "[parameters('linuxNetworkInterfacePrivateIPAddressAllocationMethod')]"
                  },
                  "subnetId": {
                    "value": "[parameters('hubSubnetResourceId')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.1008.15138",
                      "templateHash": "6520784676685160060"
                    }
                  },
                  "parameters": {
                    "name": {
                      "type": "string"
                    },
                    "location": {
                      "type": "string"
                    },
                    "tags": {
                      "type": "object",
                      "defaultValue": {}
                    },
                    "ipConfigurationName": {
                      "type": "string"
                    },
                    "subnetId": {
                      "type": "string"
                    },
                    "networkSecurityGroupId": {
                      "type": "string"
                    },
                    "privateIPAddressAllocationMethod": {
                      "type": "string"
                    }
                  },
                  "functions": [],
                  "resources": [
                    {
                      "type": "Microsoft.Network/networkInterfaces",
                      "apiVersion": "2018-11-01",
                      "name": "[parameters('name')]",
                      "location": "[parameters('location')]",
                      "tags": "[parameters('tags')]",
                      "properties": {
                        "ipConfigurations": [
                          {
                            "name": "[parameters('ipConfigurationName')]",
                            "properties": {
                              "subnet": {
                                "id": "[parameters('subnetId')]"
                              },
                              "privateIPAllocationMethod": "[parameters('privateIPAddressAllocationMethod')]"
                            }
                          }
                        ],
                        "networkSecurityGroup": {
                          "id": "[parameters('networkSecurityGroupId')]"
                        }
                      }
                    }
                  ],
                  "outputs": {
                    "id": {
                      "type": "string",
                      "value": "[resourceId('Microsoft.Network/networkInterfaces', parameters('name'))]"
                    },
                    "name": {
                      "type": "string",
                      "value": "[parameters('name')]"
                    }
                  }
                }
              }
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-06-01",
              "name": "remoteAccess-linuxVirtualMachine",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "name": {
                    "value": "[parameters('linuxVmName')]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "tags": {
                    "value": "[parameters('tags')]"
                  },
                  "vmSize": {
                    "value": "[parameters('linuxVmSize')]"
                  },
                  "osDiskCreateOption": {
                    "value": "[parameters('linuxVmOsDiskCreateOption')]"
                  },
                  "osDiskType": {
                    "value": "[parameters('linuxVmOsDiskType')]"
                  },
                  "vmImagePublisher": {
                    "value": "[parameters('linuxVmImagePublisher')]"
                  },
                  "vmImageOffer": {
                    "value": "[parameters('linuxVmImageOffer')]"
                  },
                  "vmImageSku": {
                    "value": "[parameters('linuxVmImageSku')]"
                  },
                  "vmImageVersion": {
                    "value": "[parameters('linuxVmImageVersion')]"
                  },
                  "adminUsername": {
                    "value": "[parameters('linuxVmAdminUsername')]"
                  },
                  "authenticationType": {
                    "value": "[parameters('linuxVmAuthenticationType')]"
                  },
                  "adminPasswordOrKey": {
                    "value": "[parameters('linuxVmAdminPasswordOrKey')]"
                  },
                  "networkInterfaceName": {
                    "value": "[reference(resourceId('Microsoft.Resources/deployments', 'remoteAccess-linuxNetworkInterface'), '2020-06-01').outputs.name.value]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.1008.15138",
                      "templateHash": "3504429823634436580"
                    }
                  },
                  "parameters": {
                    "name": {
                      "type": "string"
                    },
                    "location": {
                      "type": "string"
                    },
                    "tags": {
                      "type": "object",
                      "defaultValue": {}
                    },
                    "networkInterfaceName": {
                      "type": "string"
                    },
                    "vmSize": {
                      "type": "string"
                    },
                    "osDiskCreateOption": {
                      "type": "string"
                    },
                    "osDiskType": {
                      "type": "string"
                    },
                    "vmImagePublisher": {
                      "type": "string"
                    },
                    "vmImageOffer": {
                      "type": "string"
                    },
                    "vmImageSku": {
                      "type": "string"
                    },
                    "vmImageVersion": {
                      "type": "string"
                    },
                    "adminUsername": {
                      "type": "string"
                    },
                    "authenticationType": {
                      "type": "string",
                      "allowedValues": [
                        "sshPublicKey",
                        "password"
                      ]
                    },
                    "adminPasswordOrKey": {
                      "type": "secureString",
                      "minLength": 14
                    }
                  },
                  "functions": [],
                  "variables": {
                    "linuxConfiguration": {
                      "disablePasswordAuthentication": true,
                      "ssh": {
                        "publicKeys": [
                          {
                            "path": "[format('/home/{0}/.ssh/authorized_keys', parameters('adminUsername'))]",
                            "keyData": "[parameters('adminPasswordOrKey')]"
                          }
                        ]
                      }
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Compute/virtualMachines",
                      "apiVersion": "2020-06-01",
                      "name": "[parameters('name')]",
                      "location": "[parameters('location')]",
                      "tags": "[parameters('tags')]",
                      "properties": {
                        "hardwareProfile": {
                          "vmSize": "[parameters('vmSize')]"
                        },
                        "storageProfile": {
                          "osDisk": {
                            "createOption": "[parameters('osDiskCreateOption')]",
                            "managedDisk": {
                              "storageAccountType": "[parameters('osDiskType')]"
                            }
                          },
                          "imageReference": {
                            "publisher": "[parameters('vmImagePublisher')]",
                            "offer": "[parameters('vmImageOffer')]",
                            "sku": "[parameters('vmImageSku')]",
                            "version": "[parameters('vmImageVersion')]"
                          }
                        },
                        "networkProfile": {
                          "networkInterfaces": [
                            {
                              "id": "[resourceId('Microsoft.Network/networkInterfaces', parameters('networkInterfaceName'))]"
                            }
                          ]
                        },
                        "osProfile": {
                          "computerName": "[parameters('name')]",
                          "adminUsername": "[parameters('adminUsername')]",
                          "adminPassword": "[parameters('adminPasswordOrKey')]",
                          "linuxConfiguration": "[if(equals(parameters('authenticationType'), 'password'), null(), variables('linuxConfiguration'))]"
                        }
                      }
                    }
                  ],
                  "outputs": {
                    "adminUsername": {
                      "type": "string",
                      "value": "[parameters('adminUsername')]"
                    },
                    "authenticationType": {
                      "type": "string",
                      "value": "[parameters('authenticationType')]"
                    }
                  }
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', 'remoteAccess-linuxNetworkInterface')]"
              ]
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-06-01",
              "name": "remoteAccess-windowsNetworkInterface",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "name": {
                    "value": "[parameters('windowsNetworkInterfaceName')]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "tags": {
                    "value": "[parameters('tags')]"
                  },
                  "ipConfigurationName": {
                    "value": "[parameters('windowsNetworkInterfaceIpConfigurationName')]"
                  },
                  "networkSecurityGroupId": {
                    "value": "[parameters('hubNetworkSecurityGroupResourceId')]"
                  },
                  "privateIPAddressAllocationMethod": {
                    "value": "[parameters('windowsNetworkInterfacePrivateIPAddressAllocationMethod')]"
                  },
                  "subnetId": {
                    "value": "[parameters('hubSubnetResourceId')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.1008.15138",
                      "templateHash": "6520784676685160060"
                    }
                  },
                  "parameters": {
                    "name": {
                      "type": "string"
                    },
                    "location": {
                      "type": "string"
                    },
                    "tags": {
                      "type": "object",
                      "defaultValue": {}
                    },
                    "ipConfigurationName": {
                      "type": "string"
                    },
                    "subnetId": {
                      "type": "string"
                    },
                    "networkSecurityGroupId": {
                      "type": "string"
                    },
                    "privateIPAddressAllocationMethod": {
                      "type": "string"
                    }
                  },
                  "functions": [],
                  "resources": [
                    {
                      "type": "Microsoft.Network/networkInterfaces",
                      "apiVersion": "2018-11-01",
                      "name": "[parameters('name')]",
                      "location": "[parameters('location')]",
                      "tags": "[parameters('tags')]",
                      "properties": {
                        "ipConfigurations": [
                          {
                            "name": "[parameters('ipConfigurationName')]",
                            "properties": {
                              "subnet": {
                                "id": "[parameters('subnetId')]"
                              },
                              "privateIPAllocationMethod": "[parameters('privateIPAddressAllocationMethod')]"
                            }
                          }
                        ],
                        "networkSecurityGroup": {
                          "id": "[parameters('networkSecurityGroupId')]"
                        }
                      }
                    }
                  ],
                  "outputs": {
                    "id": {
                      "type": "string",
                      "value": "[resourceId('Microsoft.Network/networkInterfaces', parameters('name'))]"
                    },
                    "name": {
                      "type": "string",
                      "value": "[parameters('name')]"
                    }
                  }
                }
              }
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-06-01",
              "name": "remoteAccess-windowsVirtualMachine",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "name": {
                    "value": "[parameters('windowsVmName')]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "tags": {
                    "value": "[parameters('tags')]"
                  },
                  "size": {
                    "value": "[parameters('windowsVmSize')]"
                  },
                  "adminUsername": {
                    "value": "[parameters('windowsVmAdminUsername')]"
                  },
                  "adminPassword": {
                    "value": "[parameters('windowsVmAdminPassword')]"
                  },
                  "publisher": {
                    "value": "[parameters('windowsVmPublisher')]"
                  },
                  "offer": {
                    "value": "[parameters('windowsVmOffer')]"
                  },
                  "sku": {
                    "value": "[parameters('windowsVmSku')]"
                  },
                  "version": {
                    "value": "[parameters('windowsVmVersion')]"
                  },
                  "createOption": {
                    "value": "[parameters('windowsVmCreateOption')]"
                  },
                  "storageAccountType": {
                    "value": "[parameters('windowsVmStorageAccountType')]"
                  },
                  "networkInterfaceName": {
                    "value": "[reference(resourceId('Microsoft.Resources/deployments', 'remoteAccess-windowsNetworkInterface'), '2020-06-01').outputs.name.value]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.1008.15138",
                      "templateHash": "14429360370685585723"
                    }
                  },
                  "parameters": {
                    "name": {
                      "type": "string"
                    },
                    "location": {
                      "type": "string"
                    },
                    "tags": {
                      "type": "object",
                      "defaultValue": {}
                    },
                    "networkInterfaceName": {
                      "type": "string"
                    },
                    "size": {
                      "type": "string"
                    },
                    "adminUsername": {
                      "type": "string"
                    },
                    "adminPassword": {
                      "type": "secureString",
                      "minLength": 14
                    },
                    "publisher": {
                      "type": "string"
                    },
                    "offer": {
                      "type": "string"
                    },
                    "sku": {
                      "type": "string"
                    },
                    "version": {
                      "type": "string"
                    },
                    "createOption": {
                      "type": "string"
                    },
                    "storageAccountType": {
                      "type": "string"
                    }
                  },
                  "functions": [],
                  "resources": [
                    {
                      "type": "Microsoft.Compute/virtualMachines",
                      "apiVersion": "2021-04-01",
                      "name": "[parameters('name')]",
                      "location": "[parameters('location')]",
                      "tags": "[parameters('tags')]",
                      "properties": {
                        "hardwareProfile": {
                          "vmSize": "[parameters('size')]"
                        },
                        "osProfile": {
                          "computerName": "[take(parameters('name'), 15)]",
                          "adminUsername": "[parameters('adminUsername')]",
                          "adminPassword": "[parameters('adminPassword')]"
                        },
                        "storageProfile": {
                          "imageReference": {
                            "publisher": "[parameters('publisher')]",
                            "offer": "[parameters('offer')]",
                            "sku": "[parameters('sku')]",
                            "version": "[parameters('version')]"
                          },
                          "osDisk": {
                            "createOption": "[parameters('createOption')]",
                            "managedDisk": {
                              "storageAccountType": "[parameters('storageAccountType')]"
                            }
                          }
                        },
                        "networkProfile": {
                          "networkInterfaces": [
                            {
                              "id": "[resourceId('Microsoft.Network/networkInterfaces', parameters('networkInterfaceName'))]"
                            }
                          ]
                        }
                      }
                    }
                  ]
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', 'remoteAccess-windowsNetworkInterface')]"
              ]
            }
          ]
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('hubResourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-hub-{0}', parameters('nowUtc')))]"
      ]
    }
  ],
  "outputs": {
    "hubSubscriptionId": {
      "type": "string",
      "value": "[parameters('hubSubscriptionId')]"
    },
    "hubResourceGroupName": {
      "type": "string",
      "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-hub-rg-{0}', parameters('nowUtc'))), '2020-06-01').outputs.name.value]"
    },
    "hubResourceGroupResourceId": {
      "type": "string",
      "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-hub-rg-{0}', parameters('nowUtc'))), '2020-06-01').outputs.id.value]"
    },
    "hubVirtualNetworkName": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('hubResourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-hub-{0}', parameters('nowUtc'))), '2020-06-01').outputs.virtualNetworkName.value]"
    },
    "hubVirtualNetworkResourceId": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('hubResourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-hub-{0}', parameters('nowUtc'))), '2020-06-01').outputs.virtualNetworkResourceId.value]"
    },
    "hubSubnetName": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('hubResourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-hub-{0}', parameters('nowUtc'))), '2020-06-01').outputs.subnetName.value]"
    },
    "hubSubnetResourceId": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('hubResourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-hub-{0}', parameters('nowUtc'))), '2020-06-01').outputs.subnetResourceId.value]"
    },
    "hubSubnetAddressPrefix": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('hubResourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-hub-{0}', parameters('nowUtc'))), '2020-06-01').outputs.subnetAddressPrefix.value]"
    },
    "hubNetworkSecurityGroupName": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('hubResourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-hub-{0}', parameters('nowUtc'))), '2020-06-01').outputs.networkSecurityGroupName.value]"
    },
    "hubNetworkSecurityGroupResourceId": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('hubResourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-hub-{0}', parameters('nowUtc'))), '2020-06-01').outputs.networkSecurityGroupResourceId.value]"
    },
    "identitySubscriptionId": {
      "type": "string",
      "value": "[parameters('identitySubscriptionId')]"
    },
    "identityResourceGroupName": {
      "type": "string",
      "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-identity-rg-{0}', parameters('nowUtc'))), '2020-06-01').outputs.name.value]"
    },
    "identityResourceGroupResourceId": {
      "type": "string",
      "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-identity-rg-{0}', parameters('nowUtc'))), '2020-06-01').outputs.id.value]"
    },
    "identityVirtualNetworkName": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('identityResourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-identity-spoke-{0}', parameters('nowUtc'))), '2020-06-01').outputs.virtualNetworkName.value]"
    },
    "identityVirtualNetworkResourceId": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('identityResourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-identity-spoke-{0}', parameters('nowUtc'))), '2020-06-01').outputs.virtualNetworkResourceId.value]"
    },
    "identitySubnetName": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('identityResourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-identity-spoke-{0}', parameters('nowUtc'))), '2020-06-01').outputs.subnetName.value]"
    },
    "identitySubnetResourceId": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('identityResourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-identity-spoke-{0}', parameters('nowUtc'))), '2020-06-01').outputs.subnetResourceId.value]"
    },
    "identitySubnetAddressPrefix": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('identityResourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-identity-spoke-{0}', parameters('nowUtc'))), '2020-06-01').outputs.subnetAddressPrefix.value]"
    },
    "identityNetworkSecurityGroupName": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('identityResourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-identity-spoke-{0}', parameters('nowUtc'))), '2020-06-01').outputs.networkSecurityGroupName.value]"
    },
    "identityNetworkSecurityGroupResourceId": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('identityResourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-identity-spoke-{0}', parameters('nowUtc'))), '2020-06-01').outputs.networkSecurityGroupResourceId.value]"
    },
    "operationsSubscriptionId": {
      "type": "string",
      "value": "[parameters('operationsSubscriptionId')]"
    },
    "operationsResourceGroupName": {
      "type": "string",
      "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-operations-rg-{0}', parameters('nowUtc'))), '2020-06-01').outputs.name.value]"
    },
    "operationsResourceGroupResourceId": {
      "type": "string",
      "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-operations-rg-{0}', parameters('nowUtc'))), '2020-06-01').outputs.id.value]"
    },
    "operationsVirtualNetworkName": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('operationsResourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-operations-spoke-{0}', parameters('nowUtc'))), '2020-06-01').outputs.virtualNetworkName.value]"
    },
    "operationsVirtualNetworkResourceId": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('operationsResourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-operations-spoke-{0}', parameters('nowUtc'))), '2020-06-01').outputs.virtualNetworkResourceId.value]"
    },
    "operationsSubnetName": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('operationsResourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-operations-spoke-{0}', parameters('nowUtc'))), '2020-06-01').outputs.subnetName.value]"
    },
    "operationsSubnetResourceId": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('operationsResourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-operations-spoke-{0}', parameters('nowUtc'))), '2020-06-01').outputs.subnetResourceId.value]"
    },
    "operationsSubnetAddressPrefix": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('operationsResourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-operations-spoke-{0}', parameters('nowUtc'))), '2020-06-01').outputs.subnetAddressPrefix.value]"
    },
    "operationsNetworkSecurityGroupName": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('operationsResourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-operations-spoke-{0}', parameters('nowUtc'))), '2020-06-01').outputs.networkSecurityGroupName.value]"
    },
    "operationsNetworkSecurityGroupResourceId": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('operationsResourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-operations-spoke-{0}', parameters('nowUtc'))), '2020-06-01').outputs.networkSecurityGroupResourceId.value]"
    },
    "sharedServicesSubscriptionId": {
      "type": "string",
      "value": "[parameters('sharedServicesSubscriptionId')]"
    },
    "sharedServicesResourceGroupName": {
      "type": "string",
      "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-sharedServices-rg-{0}', parameters('nowUtc'))), '2020-06-01').outputs.name.value]"
    },
    "sharedServicesResourceGroupResourceId": {
      "type": "string",
      "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', format('deploy-sharedServices-rg-{0}', parameters('nowUtc'))), '2020-06-01').outputs.id.value]"
    },
    "sharedServicesVirtualNetworkName": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('sharedServicesResourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-sharedServices-spoke-{0}', parameters('nowUtc'))), '2020-06-01').outputs.virtualNetworkName.value]"
    },
    "sharedServicesVirtualNetworkResourceId": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('sharedServicesResourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-sharedServices-spoke-{0}', parameters('nowUtc'))), '2020-06-01').outputs.virtualNetworkResourceId.value]"
    },
    "sharedServicesSubnetName": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('sharedServicesResourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-sharedServices-spoke-{0}', parameters('nowUtc'))), '2020-06-01').outputs.subnetName.value]"
    },
    "sharedServicesSubnetResourceId": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('sharedServicesResourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-sharedServices-spoke-{0}', parameters('nowUtc'))), '2020-06-01').outputs.subnetResourceId.value]"
    },
    "sharedServicesSubnetAddressPrefix": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('sharedServicesResourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-sharedServices-spoke-{0}', parameters('nowUtc'))), '2020-06-01').outputs.subnetAddressPrefix.value]"
    },
    "sharedServicesNetworkSecurityGroupName": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('sharedServicesResourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-sharedServices-spoke-{0}', parameters('nowUtc'))), '2020-06-01').outputs.networkSecurityGroupName.value]"
    },
    "sharedServicesNetworkSecurityGroupResourceId": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('sharedServicesResourceGroupName')), 'Microsoft.Resources/deployments', format('deploy-sharedServices-spoke-{0}', parameters('nowUtc'))), '2020-06-01').outputs.networkSecurityGroupResourceId.value]"
    }
  }
}